<link rel="stylesheet" href="./CSS/wallet-multicoin.css">

<!--<script type="text/javascript" src="./JS/wallet-multicoin.js"></script>-->
<script src="/file/73066271/0">wallet-multicoin.js</script>




<script src="/file/70823524/0">TAB main-net</script>
<!--<script src="/file/7359663/0">TAB test-net</script>-->
<!--<script src="/file/196/0">TAB local-net</script>-->

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>


<!--<script src="/smart/151">OrderLib</script>-->
<script src="/file/73066534/0">OrderLib from smart</script>
<script src="/file/73011030/0">OrderLib client part test-net</script>
<script src="/file/73051568/0">OrderList JSLib</script>


<!--<script src="/smart/363">OrderLib test-net</script>-->
<!--<script src="/file/9520095/0">OrderLib client part test-net</script>-->
<!--<script src="/file/9517036/0">OrderList JSLib test-net</script>-->







<script>
    ALL_ACCOUNTS=1;
    var MapCurNum={};
    var MapBlockchains={};


    var OwnerMode;
    var SignMode=0;
    var WasSetTokenList=0;
    //var DELTA_REMOVE=50;
    //OLib.WORK_PERIOD=2;//отступ от краев внутри разрешенного диапазона работы
    OLib.CACHE_DELTA=10;//delta for cache starting
    OLib.ContractAddr="";
    OLib.EthNetworkId=undefined;
    OLib.NetMapByGate={};

    var MAX_OLD_ORDER_LENGH=20;

    var TESTMODE=0;

    var glPrivKey,glAddr;
    var SaveIdArr=["idAsset","idAddrTera","idAddrEth","idAmount","idTransferFee","idDescription", "idPrivKey","idChannel1","idChannel2"];
    var OrderArr=[];
    var MonitorMode="MY";
    var PrevMonitorMode;
    var MapPending={};
    var SendBtMap={};
    var glSendNum=0;

    var CurrentFormUID=0;





    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------
    var glNetworkId;
    function ToAddr(Str)
    {
        if(!Str)
            return "";
        if(Str.substr(0,2)!=="0x")
            Str="0x"+Str;

        return Str;
    }


    async function InitInnerEth()
    {
        glNetworkId=56;
        OLib.eth = (new Web3('https://bsc-dataseed.binance.org')).eth;
        OLib.WasMetaMaskInstalled=1;



        ethereum={};
        ethereum.request=async function(Params)
        {

            switch (Params.method)
            {
                case 'net_version':
                    return glNetworkId;

                case 'eth_requestAccounts':
                    return [ToAddr(glAddr)];

            }
            console.log(Params.method);

        }

        window.CheckMetamsk = async function()
        {
            OLib.WasMetaMaskInstalled=1;
        }


        window.SendEthExt = async function(MethodName, Arr, EthSmart)
        {
            if(!EthSmart)
                EthSmart=await ConnectEth(OLib.EthABI,OLib.ContractAddr);


            var fun=EthSmart.methods[MethodName];

            var MSend=fun.apply(this,Arr);

            var WKey={address:OLib.EthAddrFrom,privateKey:ToAddr(GetSecretKey())};
            MSend._ethAccounts.wallet[WKey.address.toLowerCase()]=WKey;
            MSend._ethAccounts.wallet.length=1;

            var Ret=MSend.send({from: OLib.EthAddrFrom, gas:500000});
            return Ret;
        }

        console.log("No use MeteMask");
    }



    //---------------------------------------------------------------------------

    var SecretKeyNew;
    var TaskMap={},PrevTaskMap={};
    function GetSecretKey()
    {

        if(SecretKeyNew)
            return SecretKeyNew.trim();
        else
        if(idPrivKey.value)
            return idPrivKey.value.trim();
        else
            return GetHexFromArr(glPrivKey);

    }

    function LoadKeyFromFile(Str,Meta)
    {
        SecretKeyNew=Str;
        SetVisibleBlock("idShowPrivKey",0);
        SetVisibleBlock("idResetPrivKey",0);
        SetVisibleBlock("idPrivKey",0);

        CalcSecret();
    }
    function CheckSignMap()
    {
        PrevTaskMap=TaskMap;
        TaskMap={};
    }


    async function CheckSignTask()
    {
        //проверяем тип хранения в буфере

        var Arr=await UpdateOrderArr();
        //console.log(Arr.length);
        for(var i=0;i<OrderArr.length;i++)
        {
            var Order=OrderArr[i];
            if(Order.PeriodNum>=4 || Order.PeriodNum<=1)
                continue;


            var BlockNum=GetOrderBlockNum(Order);
            if(BlockNum>INFO.CurBlockNum-OLib.WORK_PERIOD)//недавно добавленные ордера
                continue;

            var Key=Order.State+":"+Order.ID;
            if(TaskMap[Key] || PrevTaskMap[Key])
                continue;
            TaskMap[Key]=1;

            //console.log(Key,Order);
            //continue;

            if(Order.State==="ToSlash")
            {
                if(IsTera(Order))//tera only
                    SendOrderToSlash(Order);
            }
            else
            if(Order.State==="ToEth")
            {
                SendOrderEth(Order);
            }
            else
            if(Order.State==="ToTera")
            {
                SendOrderToTera(Order)
            }
            else
            if(Order.State==="ToSign")
            {
                SendOrderToSign(Order);
            }
            else
            if(Order.State==="ToRefund")
            {
                if(IsTera(Order))//tera only
                    SendOrderToRefund(Order);
            }


        }
    }
    function StartAutoSign()
    {
        idStartAuto.disabled=1;
        setInterval(CheckSignTask,3*1000);
        setInterval(CheckSignMap,120*1000);

        console.log("Sign mode. Start.");
    }

    //---------------------------------------------------------------------------





    // ethereum.on('accountsChanged', function (accounts)
    // {
    //     console.log("accountsChanged>",accounts);
    // });

    ethereum.on('chainChanged', function (chainId)
    {
        //console.log("chainChanged>",chainId);
        WasSetTokenList=0;
        OLib.ContractAddr="";
        OLib.DeltaConfUpdate=1;
        OLibClearCahce();
        OLib.EthNetworkId=chainId;
        UpdateMonitor();
        SetChannelList();

    });

    async function FillEthNetwork()
    {
        await CheckMetamsk();
        if(OLib.WasMetaMaskInstalled)
            OLib.EthNetworkId = await ethereum.request({ method: 'net_version' });
        else
            OLib.EthNetworkId=-1;

        FillEthSmart();
    }

    async function FillEthSmart()
    {
        if(!OLib.ConfTera)
            await GetConfTera({});
        FillGates(OLib.ConfTera);
    }



    window.addEventListener('Init',async function ()
    {

        if(SMART.Num===7)
        {
            TESTMODE=1;
            OLib.WORK_PERIOD=1;
        }

        if(SignMode || OPEN_PATH.toUpperCase().indexOf("SIGN")>=0)
        {
            OLib.WORK_PERIOD=6;
            SignMode=1;
            console.log("Sign mode. Wait.");
            SetVisibleBlock("idStartAuto",1);

            InitInnerEth();

        }

        SetVisibleBlock("idTest1",TESTMODE);

        InitPromiseMap();

        CheckTeraAcc();


        SmartGetConf();
        PrepareSavingItems();

        var Conf=await GetConfTera();

        if(TESTMODE && (!Conf || !Conf.Common))
        {
            SmartGetEmpty();
            SmartSetConf(1)
        }


        OLibClearCahce();
        UpdateOrderList(1,1);


        OLib.DeltaConfUpdate=1;

        await CheckMetamsk();

        FillEthNetwork();
        await SetTokenList();


        //setTimeout(LoadValues,10);

        //UpdateMonitor();

        //OLibClearCahce();
        // UpdateOrderList(1,1);


        // setInterval(function()
        // {
        //     OLib.DeltaConfUpdate++;
        //     if(OLib.DeltaConfUpdate>10)
        //         OLib.DeltaConfUpdate=10;
        // },5*1000)
    });




    window.addEventListener('UpdateInfo',function ()
    {
        CheckTeraAcc();
        UpdateOrderList();

        SetTokenList();
    });

    window.addEventListener('Event',function(e)
    {
        var Msg=e.detail;
        var Data=Msg.Description;

        if(Msg.Error)
        {
            SetError(Data);
        }
        else
        if(Data.cmd==="AddOrder")
        {

            if(Data.UID===CurrentFormUID && idDescription.value!=="-" && !TESTMODE)
                ClearSend();
            SetBalance();

            //console.log("Data=",Data);
            delete MapPending[Data.UID];
            UpdateOrderList(1);

        }
        else
        if(Data.cmd==="Transfer" || Data.cmd==="ExecOrder2")
        {
            SetBalance();
        }

        var Order=Data;
        if(Order.cmd && Order.Data)
            Order=Order.Data;

        if(Order.ID)
        {
            UpdateTeraCache(Order);
            UpdateOrderList(1);
        }


    });

    function CheckTeraAcc()
    {
        var CurrencyId=-1;
        var Gate=GetCurrentGateInfo();
        if(Gate)
        {
            CurrencyId=Gate.CurrencyId;
            if(Gate.IsNFT)
                CurrencyId=0;//use TERA
        }



        OwnerMode=0;
        var Arr=[],Arr0=[];;
        for(var i=0;i<USER_ACCOUNT.length;i++)
        {
            var Item=USER_ACCOUNT[i];
            if(SMART.Owner===Item.Num)
                OwnerMode=1;


            if(Item.Currency===CurrencyId)
            {
                var Value={value:Item.Num, text:Item.Num+"."+Item.Name+"  "+SUM_TO_STRING(Item.Value,Item.Currency,1)};
                Arr0.push(Value);

                if(SMART.Num==Item.Value.Smart)
                    Arr.push(Value);;


            }


        }

        UseOwnerMode();

        var Mode=GetCurrentMode();
        if(Mode==1)
            FillSelect("idAddrTera",Arr);
        else
            FillSelect("idAddrTera",Arr0);
    }
    function UseOwnerMode()
    {

        SetVisibleBlock("mOwner",OwnerMode);
        SetVisibleBlock("mSign",OwnerMode||SignMode);


        if(!OwnerMode)
        {
            var row0 = idOrders.rows[0];
            var row0cells = row0.cells;
            var nWas=-1;
            for(var n = 0; n < row0cells.length; n++)
            {
                var cell = row0cells[n];
                if(cell.id=="Item.ID")
                    nWas=n;
                if(nWas>=0)
                {
                    idOrders.ColumnArr=undefined;
                    SetVisibleBlock(cell.id,0);
                    row0.deleteCell(n);
                    n--;
                }
            }

        }

    }

    function Round(Sum)
    {
        return Math.floor(Sum*1e9)/1e9;
    }




    //--------------------------------------------------------------------------- ETH Coin
    async function AddCoinToMetamask()
    {
        var Gate=GetCurrentGateInfo();
        if(!Gate)
            return;

        var GateEth=await GetGateEth(Gate.ID);
        if(!GateEth || GateEth.TokenAddr=="0x0000000000000000000000000000000000000000")
            return SetError("Error token conf");

        var tokenImage;
        if(Gate.TokenName=='TERA')
            tokenImage = 'https://terawallet.org/tera.ico';



        try {
            // wasAdded is a boolean. Like any RPC method, an error may be thrown.
            var wasAdded = await ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: Gate.IsNFT?'ERC20':'ERC20', // Initially only supports ERC20, but eventually more!
                    options: {
                        address: GateEth.TokenAddr, // The address that the token is at.
                        symbol: Gate.TokenName, // A ticker symbol or shorthand, up to 5 chars.
                        decimals: GateEth.Decimals, // The number of decimals in the token
                        image: tokenImage, // A string url of the token logo
                    },
                },
            });
        }
        catch (error)
        {
            console.log(error);
        }
    }

    async function ChooseNet(Name)
    {
        var Map={};

        if(INFO.NETWORK==="TEST-JINN")
        {
            Map["BSC"]=[97,"BSC-TEST","BNB","https://data-seed-prebsc-1-s1.binance.org:8545","https://testnet.bscscan.com"];
        }
        else
        {
            Map["BSC"]=[56,"BSC-Mainnet","BNB","https://bsc-dataseed.binance.org/","https://bscscan.com"];
        }
        var Arr=Map[Name];
        if(!Arr)
            return SetError("Error net name="+Name);

        const data =
            [
                {
                    chainId: ToHexEth(Arr[0]), // A 0x-prefixed hexadecimal string
                    chainName: Arr[1],
                    nativeCurrency: {
                        name: Arr[2],
                        symbol: Arr[2],
                        decimals: 18,
                    },
                    rpcUrls: [Arr[3]],
                    blockExplorerUrls: [Arr[4]]
                }
            ];

        var wasAdded = await ethereum.request({method: 'wallet_addEthereumChain',params: data});
        console.log(wasAdded);
    }

    async function ConnectWallet()
    {
        await CheckMetamsk();
        await ConnectEth();

        if(NeedConnectNet==="BSC")
            ChooseNet(NeedConnectNet);
        else
        {
            var Item=MapBlockchains[NeedConnectNet];
            if(!Item)
                return;

            DoConfirm("Select network","Opent MetaMask and choose "+Item.EthDescription);

            //TODO - for future
            var wasAdded = await ethereum.request({"jsonrpc": "2.0",method: 'wallet_switchEthereumChain',params: [{chainId: ToHexEth(Item.EthNetworkId)}]});
        }

        SetVisibles();
    }

    function ToHexEth(Num)
    {
        return "0x"+Num.toString(16);
    }




    //--------------------------------------------------------------------------- ETH Send

    function FindOrderByID(ID)
    {
        if(ID)
            for(var i=0;i<OrderArr.length;i++)
            {
                var Order=OrderArr[i];
                if(Order.ID===ID)
                {
                    return Order;
                }
            }
        return SetError("Error order ID");
    }

    async function SendIDToEth(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            SendOrderEth(Order);
        }
    }
    async function SendOrderEth(Order)
    {
        try
        {
            var Ret=await SendExecOrderEth(Order);
            console.log(Ret);
        }
        catch(e){};
    }



    function ViewOrder(ID)
    {
        var Order=FindOrderByID(ID);
        if(Order)
        {
            console.log(Order);

            var Arr=[];
            var Num=0;
            for(var Name in Order)
            {
                Num++;
                var Value=Order[Name];
                if(typeof Value==="object")
                    Value=JSON.stringify(Value);
                Arr.push({Num:Num,Name:Name,Value:Value})
            }
            SetGridData(Arr,"idShow",0,1);

            DoConfirm("Order: "+Order.ID,idOrderShow.innerHTML);
        }
    }

    async function SendIDToTera(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            SendBtMap["Send"+Order.ID]=1;
            SendOrderToTera(Order);
        }
    }
    function SendOrderToTera(Order)
    {
        var Order2=GetPureOrder(Order);
        for(var p=1;p<=2;p++)
            MSendCall(0,"ExecOrder",GetPureOrder(Order),[],+idAddrTera.value);
    }


    async function SendExecOrderEth(Order)
    {
        var Conf=await GetConfTera();
        if(!Conf || !Conf.Common || !Conf.Common.MinSign)
            return SetError("Error Tera Conf");

        SendBtMap["Send"+Order.ID]=1;

        var Buf=[];
        EncodeOrder(Buf,Order,1,Conf.Common.MinSign);
        console.log("ETH Length:",Buf.length,ToBytes(Buf));
        return SendEth("ExecOrder",ToBytes(Buf));
    }



    async function SendIDToSlash(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            SendBtMap["Slash"+Order.ID]=1;
            SendOrderToSlash(Order);
        }
    }
    async function SendOrderToSlash(Order)
    {
        var Order2=CopyObjKeys({},Order);
        delete Order2.SignArr;
        var ArrRet=[];
        for(var i=0;i<Order.SignArr.length;i++)
        {
            var Item=Order.SignArr[i];
            if(!Item.Slash)
            {
                if(IsTera(Order))
                {
                    Order2.Notary=Item.Notary;
                    MSendCall(0,"SlashProof",Order2,Item.Sign,+idAddrTera.value);
                }
                else
                {
                    var Buf=[];
                    EncodeOrder(Buf,Order,0);

                    var SignStr=GetHexFromArr(Item.Sign);
                    var StrR=SignStr.substr(0,32*2);
                    var StrS=SignStr.substr(32*2,32*2);
                    var StrV=SignStr.substr(64*2,2);

                    var Ret = SendEth("SlashProof",ToBytes(Buf),0,ToBytes(StrR),ToBytes(StrS),ToBytes(StrV));
                    ArrRet.push(Ret);
                }
                Item.Slash=1;
            }
        }

        for(var i=0;i<ArrRet.length;i++)
        {
            console.log(await Ret);
            UpdateTeraCache(Order);
            //delete OLib.MAP_ETH[Order.ID];
        }
    }

    async function SendIDToRefund(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order && OLib.ConfTera)
        {
            SendBtMap["Refund"+Order.ID]=1;
            SendOrderToRefund(Order);
        }
    }
    async function SendOrderToRefund(Order)
    {
        if(IsTera(Order))
        {
            MSendCall(0,"CancelOrder",{ID:Order.ID},[],+idAddrTera.value);
        }
        else
        {
            var Ret=await SendEth("CancelOrder",Order.ID);
            console.log(Ret);
            UpdateTeraCache(Order);
            //delete OLib.MAP_ETH[Order.ID];
        }
    }

    async function SendIDToSign(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order && OLib.ConfTera)
        {
            SendBtMap["Sign"+Order.ID]=1;
            SendOrderToSign(Order)
        }
    }
    async function SendOrderToSign(Order)
    {
        if(!OLib.ConfTera)
            return;

        if(IsTera(Order))
        {
            var SignArr=GetSignOrder(Order,glPrivKey);
            MSendCall(0,"NotarySign",{ID:Order.ID, Notary:0},SignArr,+idAddrTera.value);
        }
        else
        {

            var SignStr=GetHexFromArr(GetSignOrder(Order,glPrivKey));
            var StrR=SignStr.substr(0,32*2);
            var StrS=SignStr.substr(32*2,32*2);
            var StrV=SignStr.substr(64*2,2);

            //console.log(StrR,StrS,StrV);

            var Ret=await SendEth("NotarySign",Order.ID,0,ToBytes(StrR),ToBytes(StrS),ToBytes(StrV));
            console.log(Ret);
            UpdateTeraCache(Order);
            //delete OLib.MAP_ETH[Order.ID];
        }
    }


    //--------------------------------------------------------------------------- TERA Send
    function ChooseToken()
    {
        idAmount.value=1;
        SendCoins();
    }

    async function SendCoins()
    {
        let Conf=await GetConfTera();
        if(!Conf.Common.NotaryArr)
            return SetError("Error Notary dapp params");




        await ["idAsset","idChannel1","idChannel2","idAddrTera","idAddrEth","idAmount"].forEach(function(id)
        {
            if(!$(id).value)
            {
                SetError("Need set "+id.substr(2));
                throw "Error";
            }

        });


        let Order=await FormToOrder(Conf);
        if(!Order)
            return;




        var StrMode;
        if(Order.AddrEth.length<10)
            StrMode="TERA → TERA";
        else
            StrMode=idChannel1.value+" → "+idChannel2.value;



        DoConfirm("Send "+StrMode,CreateSendHTML(Order),async function()
        {
            if(Order.AddrEth.length<10)
            {
                var To=+Order.AddrEth;
                if(!To)
                    return SetError("Error addr To = "+To);

                return MSendCall(+idAddrTera.value,"Transfer",{Token:Order.Token, To:To, ID:Order.TokenID, Amount:Order.Amount, Description:Order.Description},[],+idAddrTera.value);
            }

            SelectTabMenu("mTx");
            SelectTabMenu("mMy");
            SetMonitorMode("MY");

            glSendNum++;
            Order.ID=GetCurrentBlockNumByTime()*100000+(glSendNum%1000);
            let UID=Order.ID;
            Order.UID=UID;
            CurrentFormUID=Order.UID;
            Order.Pending=1;
            Order.SignArr=[];
            MapPending[Order.UID]=Order;

            if(Order.Mode==2)//Mode Eth to Tera
                Order.Pending=2;
            UpdateOrderList(1);

            if(Order.Mode==2)//Mode Eth to Tera
            {
                try
                {
                    let RetSend=await SendAddOrderEth(Order);
                    console.log(RetSend);
                }
                catch(e){};

                delete MapPending[UID];
            }
            else
            {
                var Order2=GetPureOrder(Order);
                Order2.UID=UID;
                delete Order2.ID;
                delete Order2.AddrTera;
                //console.log(Order2);
                //return;

                //console.log(CopyObjKeys({},Order2));
                if(!MSendCall(+idAddrTera.value,"AddOrder",Order2,[],+idAddrTera.value))
                    return;
            }
        });
    }
    function DoConfirm3(a,b,F)
    {
        F();
    }


    async function FormToOrder(Conf)
    {
        if(!Conf)
            Conf=OLib.ConfTera;
        if(!Conf)
            return;

        var Mode=GetCurrentMode();

        var Gate=GetCurrentGateInfo();
        var bNFT=(Gate && Gate.IsNFT);
        if(bNFT)
        {
            if(!idAmount.value)
                idAmount.value=1;
            if(Mode==2)
                idAmount.value=1;
        }



        var Order=
            {
                Mode:Mode,
                Gate:Gate.ID,
                AddrTera:+idAddrTera.value,
                AddrEth:idAddrEth.value,
                Amount:Round(+idAmount.value),
                //TransferFee:Round(+idTransferFee.value),
                TransferFee:0,
                Description:idDescription.value,
            }
        if(Mode==1)
        {
            Order.TransferFee=MapBlockchains[Gate.ChainName].TransferFee;//TODO Gate.TransferFee
        }



        Order.Token=GetTokenByGate(Order.Gate);
        Order.StrImg="";
        if(bNFT)
        {
            if(!idListNFT.CurSelect)
                return SetError("Need select NFT");

            var Element=$(idListNFT.CurSelect);
            Order.StrImg=Element.innerHTML;
            Order.Token=Element.dataset.token;
            Order.TokenID=Element.dataset.id;

            //Order.TokenID=GetValidTokenID(idTokenID.value);
            if(!Order.TokenID)
                return;

        }



        Order.AddrEth=ToBytes(Order.AddrEth).substr(2);


        var Gate2;
        var Common;
        var NativeName;
        if(Order.Mode==1 || TESTMODE)
        {
            NativeName="Tera";
            Common=Conf.Common;
            Gate2=Gate;
        }
        else
        {
            NativeName="Eth";
            Gate2=await GetGateEth(Order.Gate);
            Common=await GetCommonEth();
        }
        if(!Gate2 || !Common)
            return;



        if(bNFT)
        {
            //комиссия в газе и всегда равна MinNotaryFee
            Order.NotaryFee=Common.MinNotaryFee;
            //console.log(Order)

            Order.ArrTotal=[[Round(Order.Amount),Order.Token,],[Round(Order.NotaryFee+Order.TransferFee),NativeName]];
        }
        else
        {
            var NeedFee=Common.NotaryFee*(Order.Amount+Order.TransferFee);
            Order.NotaryFee=Round(Math.max(NeedFee,Gate2.Rate*Common.MinNotaryFee));

            Order.ArrTotal=[[Round(Order.Amount+Order.TransferFee+Order.NotaryFee),Order.Token]];
        }

        return  Order;
    }

    function GetValidTokenID(Str)
    {
        return Str;
    }


    function CreateSendHTML(Order)
    {
        var Arr=[];
        Arr[(Order.Mode+1)%2]=Order.AddrTera;
        Arr[(Order.Mode)%2]=Order.AddrEth;

        var Str=`
        <DIV align='left'>
        <hr>
        <txtr><txth>From:</txth><txtshort>${Arr[0]}</txtshort></txtr>
        <txtr><txth>To:</txth><txtshort>${Arr[1]}</txtshort></txtr>
        <grid_nft style="min-width: 250px;width:250px" class="${Order.StrImg?'':'hide'}"><item_nft>${Order.StrImg}</item_nft></grid_nft>
        <txtr><txth>Amount:</txth><txtvo>${Order.Amount}</txtvo>
        <txthfee class="${Order.TransferFee==0?'hide':''}">Transfer:<txtvo>${Order.TransferFee}</txtvo></txthfee><txthfee>Notary:<txtvo>${Order.NotaryFee}</txtvo></txthfee></txtr>
        <txtr><txth>Description:</txth><txtv>${Order.Description}</txtv></txtr>
        <hr>
        <txtr><txth>TOTAL:</txth>`

        for(var i=0;i<Order.ArrTotal.length;i++)
        {
            var Item=Order.ArrTotal[i];
            Str += `<txtvo>${Item[0]}</txtvo>${Item[1]}`;
        }

        Str += "</txtr></DIV>"




        return Str;
    }

    function ClearSend()
    {
        ["idAmount","idDescription"].forEach(id => $(id).value="");
    }





    function ViewMonitor()
    {
        var Arr=[];
        if(MonitorMode==="ALL")
        {
            Arr=OrderArr;
        }
        else
            for(var i=0;i<OrderArr.length;i++)
            {
                var Item=OrderArr[i];
                if(Item.State===undefined)
                    console.log(Item);
                if(Item.PeriodNum>=4)
                    continue;

                // if(MonitorMode==="MY" && !Item.Final && IsMyOrder(Item))
                //     Arr.push(Item);
                // else
                // if(MonitorMode==="MYFINISH" && Item.Final && IsMyOrder(Item))
                //     Arr.push(Item);
                if(MonitorMode==="MY" && IsMyOrder(Item))
                    Arr.push(Item);
                else
                if(MonitorMode==="SLASH" && Item.State==="ToSlash")
                    Arr.push(Item);
                else
                if(MonitorMode==="TOETH" && Item.State==="ToEth")
                    Arr.push(Item);
                else
                if(MonitorMode==="TOTERA" && Item.State==="ToTera")
                    Arr.push(Item);
                else
                if(MonitorMode==="REFUND" && Item.State==="ToRefund")
                    Arr.push(Item);


            }
        var bClear=(MonitorMode!==PrevMonitorMode);

        //console.log(Arr.length, OrderArr.length, Arr.length?Arr[0].ID:'-');

        if(window.SetGridDataNew)
            SetGridDataNew(Arr,"idOrders",bClear);
        else
            SetGridData(Arr,"idOrders",0,bClear,1);


        PrevMonitorMode=MonitorMode;
    }



    function SetMonitorMode(Str)
    {
        MonitorMode=Str;
        ViewMonitor();
    }

    function SetEthCurAddres()
    {
        idAddrEth.value=OLib.EthAddrFrom;
        SaveValues();
        SetBalance();
    }

    function GetCurrentMode()
    {
        if(idChannel1.value=="TERA")
            return 1;
        else
            return 2;
    }
    function GetCurrentGateInfo()
    {
        var Data=MapCurNum[idAsset.value];

        if(Data)
            for(var key in Data.Gates)
            {
                var Item=Data.Gates[key];
                if(Item.ChainName==idChannel1.value || Item.ChainName==idChannel2.value)
                {
                    return Item;
                }
            }
    }

    function GetTokenByGate(ID)
    {
        if(!OLib.ConfTera)
            return "";
        var Item=OLib.ConfTera.Gates[ID];
        if(Item)
            return Item.TokenName;
        else
            return "";
    }

    function UpdateMapCurNum(Conf)
    {
        //console.log(Conf.Gates);
        var Count=0;
        MapCurNum={};
        MapBlockchains={}
        MapBlockchains=CopyObjKeys({TERA:{EthDescription:"TERA Network",OrderEnum:0,EthImage:"https://terafoundation.org/img/tera.png"}},Conf.Blockchains);


        for(var key in Conf.Gates)
        {
            var Item=Conf.Gates[key];
            if(!Item.Pause && Item.Rate)
            {
                var Data=MapCurNum[Item.CurrencyId];
                if(!Data)
                {
                    Data={Gates:{},Name:Item.TokenName};
                    MapCurNum[Item.CurrencyId]=Data;

                    if(!Data.Name)
                        Data.Name=CurrencyName(Item.CurrencyId);

                }
                Data.Gates[key]=Item;
                Count++;
            }
        }
        return Count;
    }

    function UpdateMonitor()
    {
        OLibClearCahce();
        UpdateOrderList(1,1);
    }

    async function SetTokenList()
    {
        if(WasSetTokenList)
            return;

        var Conf=await GetConfTera();
        if(!Conf)
            return;

        if(!UpdateMapCurNum(Conf))
            return;

        var Arr=[];
        for(var key in MapCurNum)
        {
            var Item=MapCurNum[key];
            var Value={value:key, text:Item.Name, Style:"background-image: url(imgselect/01.gif);"};
            Arr.push(Value);
        }

        FillSelect("idAsset",Arr);


        SetChannelList();
        WasSetTokenList=1;


    }

    async function SetChannelList()
    {
        if(!FirstPromise("SetChannelList"))
            return;
        SetChannelListNext();
        LeavePromise("SetChannelList");
    }

    async function SetChannelListNext()
    {
        if(OLib.EthNetworkId==undefined)
            await FillEthNetwork();


        var Arr0=[];

        for(var key in MapBlockchains)
        {
            var Item=MapBlockchains[key];
            Arr0.push({value:key, text: Item.EthDescription});
        }
        FillSelect("idChannel1",Arr0);
        FillSelect("idChannel2",Arr0);



        OnSelectBridge();
        CheckTeraAcc();

        LoadValues();
        SetBalance();
    }

    //---------------------------------------------------------------------------
    function ChooseChainFrom()
    {
        CheckSelectedChain(idChannel2);
        SetDefaultAddrEth();

        SetVisibles();
    }
    function ChooseChainTo()
    {
        CheckSelectedChain(idChannel1);
        SetDefaultAddrEth();

        SetVisibles();
    }
    function SwapChain()
    {
        var temp=idChannel1.value;
        idChannel1.value=idChannel2.value;
        idChannel2.value=temp;

        CheckSelectedChain();
        SetDefaultAddrEth();
        SetVisibles();
    }

    function CheckSelectedChain(id)
    {
        if(!id)
            id=idChannel1;

        if(!idChannel1.value)
            idChannel1.value="TERA";
        if(!idChannel2.value)
            idChannel2.value="TERA";

        var CountTera=0;
        if(idChannel1.value=="TERA")
            CountTera++;
        if(idChannel2.value=="TERA")
            CountTera++;

        if(!CountTera)
        {
            id.value="TERA";
        }
        else
        if(CountTera==2)
        {
            id.value="BSC";
        }

    }
    function SetDefaultAddrEth()
    {
        SetEthCurAddres();
    }

    //---------------------------------------------------------------------------

    function CreateAccount()
    {
        var Gate=GetCurrentGateInfo();
        if(!Gate)
            return;
        CreateNewAccount(Gate.IsNFT?0:Gate.CurrencyId);
    }



    async function SetVisibleAddCoin()
    {
        var bView=0;
        var Gate=GetCurrentGateInfo();
        if(Gate)
        {
            var GateEth=await GetGateEth(Gate.ID,1);
            if(GateEth && GateEth.TokenAddr!="0x0000000000000000000000000000000000000000")
                bView=1;
            //console.log("Gate",Gate,"GateEth",GateEth);
        }

        SetVisibleBlock("idAddMetamask",(bView||TESTMODE)?"flex":"none");


    }

    async function OnSelectCurrency()
    {
        SetChannelList();
        SetVisibles();
        OnSelectAddrTera();
    }

    async function OnSelectBridge()
    {
        SetVisibleAddCoin();
        SetVisibles();
    }

    async function OnSelectAddrTera()
    {
        SetBalance();
    }

    var NeedConnectNet;
    function SetChainInfo(Mode,Num)
    {

        var id=$("idChannelInfo"+Num);
        var key=$("idChannel"+Num).value;
        var Item=MapBlockchains[key];
        if(!Item)
            return;
        id.innerText=Item.EthDescription;
        $("idChannelImg"+Num).src=Item.EthImage;

        if(Mode==2 && Item.EthNetworkId && Item.EthNetworkId!=OLib.EthNetworkId)
        {
            NeedConnectNet=key;
            SetVisibleBlock("idConnectWallet","flex");
            if(key=="BSC")
                SetVisibleBlock("idAddBSC","flex");
        }
    }

    function SetVisibles()
    {
        CheckSelectedChain();
        SetVisibleAddCoin();

        var Mode=GetCurrentMode();

        SetVisibleBlock("idConnectWallet","none");
        SetVisibleBlock("idAddBSC","none");

        NeedConnectNet="";
        SetChainInfo(Mode,1);
        SetChainInfo(Mode,2);

        var Gate=GetCurrentGateInfo();
        var bNFT=(Gate && Gate.IsNFT);

        SetVisibleBlock("idTypeNFT",bNFT);


        SetVisibleBlock("idBlockTrFee",0);// Mode==1);

        SetBalance();



        idAddAsset.innerText=Gate?Gate.TokenName:"";

        if(Mode==2)
            MoveUp(idRowEth);
        else
        if(Mode==1)
            MoveUp(idRowTera);

        $("idInfoAddr"+(1+(Mode+1)%2)).innerText="Sender address";
        $("idInfoAddr"+(1+Mode%2)).innerText="Destination address";


        idBtSend.disabled=(Mode==2 && (!OLib.WasMetaMaskInstalled || NeedConnectNet))?1:0;
    }

    async function SetBalance()
    {
        var Str=await GetBalance();
        idBalance.innerText=Str?"Balance: "+Str:"";

        FillListGateNFT();
    }

    async function GetBalance()
    {
        var Gate=GetCurrentGateInfo();
        if(!Gate)
            return "";

        var Mode=GetCurrentMode();

        var Ret=0;
        if(Mode==1 && idAddrTera.value)
        {
            var Acc=USER_ACCOUNT_MAP[idAddrTera.value];
            if(!Acc)
                return "";
            if(Gate.IsNFT || Gate.IsERC)
            {
                return "";
            }
            else
                Ret=FLOAT_FROM_COIN(Acc.Value);
        }
        else
        if(Mode==2 && idAddrEth.value)
        {
            var GateEth=await GetGateEth(Gate.ID);
            if(!GateEth || !GateEth.WORK_MODE)
                return "";

            var Amount=0;
            if(GateEth.TypeERC==0)//native gas
            {
                var Balance = await ethereum.request({ method: 'eth_getBalance', params:[idAddrEth.value, "latest"] });
                if(Balance)
                    Amount=parseInt(Balance.substr(2), 16);
            }
            else
            {
                Amount=await CallEthERC(GateEth.TokenAddr,"balanceOf",ToBytes(idAddrEth.value));
            }


            Ret=Amount/(10**GateEth.Decimals);

        }
        return ""+Ret+" "+GetTokenByGate(Gate.ID);
    }
    async function SetMaxAmount()
    {
        var Str=await GetBalance();
        if(!Str)
            Str="0";
        idAmount.value=parseInt(Str);

    }


    function GetCoinStoreNum()
    {
        // if(SMART.Num===7)
        //     return 107;

        if(INFO.NETWORK==="MAIN-JINN")
            return 231941;

        if(INFO.NETWORK==="TEST-JINN")
            return 975;

        return 0;
    }

    async function FillListGateNFT()
    {
        var Gate=GetCurrentGateInfo();
        var bNFT=(Gate && Gate.IsNFT);

        if(bNFT)
        {

            var Mode=GetCurrentMode();



            if(Mode==1)
            {
                var Account=+idAddrTera.value;
                FillListNFT(idListNFT,Account,Account*10000, Gate.TokenName, 1);
            }
            else
            {
                var Arr=[];
                var GateEth=await GetGateEth(Gate.ID);
                if(GateEth && GateEth.TokenAddr)
                {
                    var List=await CallEthERC(GateEth.TokenAddr,"GetTokenList",idAddrEth.value,50);
                    for(var i=0;i<List.length;i++)
                    {
                        var TokenID=List[i];
                        Arr.push({ID:TokenID,SumCOIN:1,SumCENT:0,URI:"/nft/"+TokenID});
                    }
                }

                var Tokens={Arr:[{Token:Gate.TokenName,Arr:Arr}]};
                FillListNFT(idListNFT,Tokens,Gate.OrderEnum*10000, "", 1);

                //console.log("Gate:",Gate);
            }
        }
    }



    // function OnSelectNFTItem(IDList,element)
    // {
    //     idTokenID.value=element.dataset.id;
    // }


    //--------------------------------------------------------------------------- Owner smart
    function SmartGetEmpty()
    {
        var Params=
            {
                EthSmartAddr:"",
                SignLib:0,
                CoinStore:0,
                Common:
                    {
                        Pause:0,
                        SignPeriod:14400,//период для подписи (в блоках)
                        TransferPeriod:28800,//устаревание ордеров (в блоках)

                        //комиссии за подпись (в Терах)
                        NotaryFee:0.01,
                        MinNotaryFee:1,
                        MinDeposit:100000, //депозит в Терах

                        //подписанты (валидаторы)
                        NotaryArr:[{Addr:"0000000000000000",AccDeposit:0,SumDeposit:0, CanSign:1, BlockFrom:0, BlockTo:0, Gates:[1,2,3]}],
                        MinSign:1,//требуемое минимальное число подписей

                        //штрафные санкции
                        SlashRate:1,
                        MinSlash:1000,

                    },
                Blockchains:
                    {
                        "NAME"://имя блокчейна
                            {
                                EthNetworkId:0,//eth номер сети
                                EthSmartAddr:"",//адрес смарт-контракта
                                OrderEnum:0,//глобальный номер блокчейна - влияет на создание ID ордера (в наших терминах: 0=Tera, 1=Eth, 2=BSC, до 99)
                                EthDescription:"",//название сети
                                EthImag:"",//иконка
                                TransferFee:0,
                            }
                    },
                Gates:
                    {
                        "0":
                            {
                                ID:0,//глобальный уникальный номер канала
                                ChainName:"NAME",
                                CurrencyId:0,//номер валюты (номер даппа)
                                TokenName:"",
                                TokenAcc:0,//номер счета с монетами
                                Rate:1,//курс к Тера для расчета слэшинга или минимальной комисии
                                Pause:0,
                            }
                    },
                Orders:
                    {
                        HeadID:0,
                        TailID:0,

                        NewOrderID:0,
                        WorkNum:0,
                    }

            };


        if(TESTMODE)
        {
            Params.SignLib=283;
            Params.CoinStore=975;
            Params.Common.SignPeriod=10;
            Params.Common.TransferPeriod=20;
            Params.EthSmartAddr="";//"0xbc4d60aa28ab4e8f51c469917a7d2b5cba46c740";
            Params.Common.NotaryArr=[{Addr:"5201A60DE4328750EC18C6BEA49B2DA10A82013F",AccDeposit:0,SumDeposit:110000, CanSign:1, BlockFrom:0, BlockTo:0, Gates:[1,2,3]}];
            Params.Blockchains=
                {
                    "ETH":
                        {
                            EthNetworkId:4,//main 1
                            EthSmartAddr:"",
                            OrderEnum:1,
                            EthDescription:"Ethereum Network",
                            EthImage: "https://terafoundation.org/img/ethereum.png",
                            TransferFee:1000,
                        },
                    "BSC":
                        {
                            EthNetworkId:97,//main 56
                            EthSmartAddr:"",
                            OrderEnum:2,
                            EthDescription:"BSC Network",
                            EthImage: "https://terafoundation.org/img/binance.png",
                            TransferFee:50,
                        }
                };

            Params.Gates=
                {
                    "1":
                        {
                            ID:1,
                            ChainName:"ETH",
                            CurrencyId:0,
                            TokenName: "TERA",
                            TokenAcc:107,
                            Rate:1,
                            Pause:0
                        },
                    "2":
                        {
                            ID:2,
                            ChainName:"BSC",
                            CurrencyId:0,
                            TokenName: "TERA",
                            TokenAcc:107,
                            Rate:1,
                            Pause:0
                        },
                    "3":
                        {
                            ID:3,
                            ChainName:"ETH",
                            CurrencyId:1,
                            TokenName:"USD",
                            TokenAcc:101,
                            Rate:0.03,
                            Pause:0
                        },
                    "10":
                        {
                            ID:10,
                            ChainName:"ETH",
                            CurrencyId:2,
                            IsNFT:1,
                            TokenName:"PNTX",
                            TokenAcc:0,
                            Rate:1,
                            Pause:0
                        },
                    "11":
                        {
                            ID:11,
                            ChainName:"BSC",
                            CurrencyId:3,
                            IsNFT:1,
                            TokenName:"BEAM",
                            TokenAcc:0,
                            Rate:1,
                            Pause:0
                        },
                }
        }
        idSettings.value=JSON.stringify(Params,"",4);
    }

    function SmartSetConf(bTestInit)
    {
        if(!idSettings.value)
            return SetError("Need set params");
        var Conf=JSON.parse(idSettings.value);
        MSendCall(0,"SetCommon",Conf,[],SMART.Owner);

    }

    async function Test2()
    {
    }

    function SmartResetOrders()
    {
        MSendCall(0,"ResetOrders",{},[],SMART.Owner);
    }




    async function SmartGetConf()
    {
        OLibClearCahce();

        var Conf=await GetConfTera();
        if(Conf)
            for(var key in Conf.Gates)
            {
                var Item=Conf.Gates[key];
                delete Item.EthNetworkId;
                delete Item.EthSmartAddr;
                delete Item.OrderEnum;
            }

        idSettings.value=JSON.stringify(Conf,"",4);
    }

    async function SmartGetProxy()
    {
        var Data=await CallTeraProxy(0,"GetProxy",{});
        console.log("Data",Data);
        idSettings.value=JSON.stringify(Data,"",4);
    }
    function SmartSetProxy()
    {
        if(!idSettings.value)
            return SetError("Need set params");
        var Params=JSON.parse(idSettings.value);
        MSendCall(0,"SetProxy",Params,[],SMART.Owner);
    }




    //--------------------------------------------------------------------------- Private key support
    function SetPubKey(bSave)
    {
        glPubKey=SignLib.publicKeyCreate(glPrivKey, 0);
        glAddr=GetHexFromArr(GetAddrFromPubKey(glPubKey));
        idPubKey.value=glAddr;
        if(bSave)
            SaveValues();
    }

    function CalcSecret(bSave)
    {
        var Key=GetSecretKey();
        if(Key)
        {
            glPrivKey=GetArrFromHex(Key);
            SetPubKey(bSave);
        }
        else
        {
            var PubKey=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2];

            ComputeSecret(PubKey,function (ArrSecret)
            {
                glPrivKey=ArrSecret;
                SetPubKey(bSave);
            },+idAddrTera.value);
        }

    }
    function ShowPrivKey()
    {
        if(SecretKeyNew)
            return;

        idPrivKey.value=GetHexFromArr(glPrivKey);
        SetPubKey();


        SetVisibleBlock("idPrivKey",1);
        setTimeout(function()
        {
            SetVisibleBlock("idPrivKey",0);
        },10*1000);
    }

    //--------------------------------------------------------------------------- Saving support
    function SaveValues()
    {
        CurrentFormUID=0;
        SaveToStorageByArr(SaveIdArr);
    }
    var WasLoad=0;
    function LoadValues()
    {
        if(WasLoad)  return;
        WasLoad=1;

        LoadFromStorageByArr(SaveIdArr,async function (Key)
        {
            if(OwnerMode)
                CalcSecret(0);

            await SetChannelList();
            OnSelectCurrency();
            OnSelectBridge();
            SetBalance();
        },1);
    }
    function PrepareSavingItems()
    {
        for(var n = 0; n < SaveIdArr.length; n++)
        {
            var Item = $(SaveIdArr[n]);
            Item.addEventListener("change",SaveValues);
        }
    }




    //--------------------------------------------------------------------------- TEST MODE
    var TestNum=1;
    function GetTestOrder()
    {

        TestNum+=2;
        var AddrTo = new Uint8Array(20);
        window.crypto.getRandomValues(AddrTo);

        var Order={Gate:1, AddrTera:100, AddrEth:AddrTo, TokenID:"", Amount:random(1000),TransferFee:3, NotaryFee:1, Description:"Super test "+TestNum,  Process:0,PrevID:0,NextID:0};
        Order.AddrEth=GetHexFromArr(Order.AddrEth);
        return Order;
    }

    var LastTestOrder;
    function TestSlashProof()
    {

        var Order;
        if(LastTestOrder)
            Order=LastTestOrder;
        else
        {
            Order=GetTestOrder();
            Order.Amount=100;
            Order.TransferFee=100;
            Order.Gate=3;
            var BlockNum=INFO.CurBlockNum-OLib.ConfTera.Common.SignPeriod-5;
            Order.ID=BlockNum*100000;
            LastTestOrder=Order;
        }

        var SignArr=GetSignOrder(Order,glPrivKey);
        Order.Notary=0;
        MSendCall(0,"SlashProof",Order,SignArr,+idAddrTera.value);
    }

    var LastTestOrder2;
    function TestExecOrder()
    {
        var Order;
        if(LastTestOrder2)
            Order=LastTestOrder2;
        else
        {
            Order=GetTestOrder();
            var BlockNum=INFO.CurBlockNum-5;
            Order.ID=BlockNum*100000+1000*1;
            LastTestOrder2=Order;
        }

        var SignArr=GetSignOrder(Order,glPrivKey);

        Order.SignArr=[{Notary:0,Slash:0,Sign:SignArr}];
        MSendCall(0,"ExecOrder",Order,[],+idAddrTera.value);
    }

    function OpenHistoryPage(Num)
    {
        OpenLink("/history.html#"+Num);
    }


    async function DoGetOrder()
    {
        var Ret1=await ReadOrderTera(+idOrder.value);
        console.log("Tera:",Ret1);
        var Ret2=await ReadOrderEth(+idOrder.value);
        console.log("ETH:",Ret2);
    }

    // async function DoGetNFT()
    // {
    //     var Gate=GetCurrentGateInfo();
    //     if(!Gate)
    //         return;
    //     var GateEth=await GetGateEth(Gate.ID);
    //     if(!GateEth || !GateEth.TokenAddr)
    //         return SetError("No GateEth.TokenAddr");

    //     var Ret=await CallEthERC(GateEth.TokenAddr,"ownerOf",idTokenID.value);
    //     console.log("Ret:",Ret);
    // }

    // async function DoNFTEventList()
    // {
    //     var Gate=GetCurrentGateInfo();
    //     if(!Gate)
    //         return;
    //     var GateEth=await GetGateEth(Gate.ID);
    //     if(!GateEth || !GateEth.TokenAddr)
    //         return SetError("No GateEth.TokenAddr");

    //     var List=await CallEthERC(GateEth.TokenAddr,"GetTokenList",idAddrEth.value,50);
    //     console.log("List:",List);

    // }



    // //tokennfttx
    // function DoNFTEventList11()
    // {
    //     //tokenOfOwnerByIndex

    //     var ApiKey="";
    //     var ApiServer="https://api-testnet.bscscan.com";
    //     //asc desc
    //     var Page="&page=1&offset=500";//max 500 rows
    //     var Contract="&contractaddress=0xdc2459a24441fccf9c8a9c09fc3644d79d204aad";
    //     Contract="";
    //     var AddrTo=idAddrEth.value;

    //     var Addr=ApiServer+"/api?module=account&action=tokennfttx"+Contract+"&address="+AddrTo+"&startblock=0&endblock=last&sort=desc"+Page+"&apikey="+ApiKey;
    //     fetch(Addr, {method:'get', cache:'default', mode:'cors', credentials2:'include', headers:this.Headers}).then(function (response)
    //     {
    //         response.json().then(function (data)
    //         {
    //             console.log(data);
    //         });
    //     }).catch(function (err)
    //     {
    //     });
    // }

    async function DoNFTEventList22()
    {
        const accounts = await ethereum.request({ method: 'eth_accounts' });
        console.log("Account:",accounts);
        const Balance = await ethereum.request({ method: 'eth_getBalance', params:[accounts[0], "latest"] });
        console.log("Balance:",Balance);


        const List = await ethereum.request({ method: 'tokennfttx', params:[accounts[0], "latest"] });
        console.log("List:",List);
    }

</script>




<style>
    :root
    {
        --colorTabB1: rgba(255, 255, 255, 0.6);
        --colorTabB2: #53687e;
        --colorTabB3: #2a3446;
    }

    body
    {
        background-color: #415065;
        color: white;
        margin:0px;
    }

    input
    {
        width: 70px;
    }

    button, .btfile
    {
        height: 32px;
        width: 95px;
        margin: 5px;
        color:white;
        background-color: #2E3857;
        border: 1px solid #888;
    }
    button[disabled]
    {
        color: gray;
        cursor:none;
    }

    button:hover, .btfile
    {
        color: #cb763a;
        cursor: pointer;
    }
    button[disabled]:hover
    {
        color: gray;
        cursor:none;
    }
    .btaction
    {
        width: 70px;
        padding:0;
        margin:0;
        height:26px;
    }
    .btlist
    {
        width: 150px;
        height:40px;
        margin:10px 2px 30px 2px;
    }


    .row
    {
        margin: 10px 0px 10px 5px;
        font-size: 16px;

        display: flex;
        align-items: flex-end;
    }
    .row_info
    {
        display: flex;
        margin: -5px 5px;
        font-size: 14px;
        justify-content: flex-end;
    }
    .row_info p
    {
        margin-top: 6px;
    }
    .addr-box
    {
        width:149px;
        height:160px;
        margin:auto;

    }
    .chain-box
    {
        width:149px;
        height:144px;
        border: 1px solid #576B83;
        background: #45556A;
        border-radius:5px;
        box-shadow: rgb(11 14 17 / 16%) 0px 2px 8px;
    }

    row_cell
    {
        width:99%;
    }

    .row-head
    {
        display: block;
        margin: 2px;
        text-align: left;
    }
    .row-item
    {
        background-color2: #CCC;
        margin: 2px;
        padding:0px;
        height:30px;
        width:99%;
    }
    .amount
    {
        color:#1e21cb;
        font-weight: bold;
    }
    .row2
    {
        display: flex;
        margin: 10px 5px;
        font-size: 16px;
    }

    .marginl10
    {
        margin-left:10px;
    }

    txtr
    {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        margin: 5px;
    }
    txth
    {
        font-weight: bold;
    }
    txthfee
    {
        font-weight: normal;
        font-size: 12px;
    }

    txtv
    {
        margin-left: 5px;
    }
    txtvo
    {
        margin-left: 5px;
        color:#E9764B;
        font-weight: bold;
        padding: 0 5px;
    }
    txtshort
    {
        margin-left: 5px;
        font-size: 12px;
        padding-top:3px;
    }

    #idConfirm
    {
        background-color:#DBE2F8;
        max-width2: 300px;
    }
    #idConnect
    {
        height:50px;
        width:200px;
    }

    .hide
    {
        display: none;
    }


    /*Списки*/
    table
    {
        border-collapse: collapse;
        width:100%;
        max-width: 800px;
        margin-top:5px;

    }
    .grid th
    {
    }

    .grid th, .grid td
    {
        border: 1px solid #576B83;
        padding: 4px;

        font-size: 14px;
        font-family:monospace;
    }
    .grid td
    {
        color:lightgray;
        width: 60px;
        vertical-align:center;
    }
    .grid td.sum
    {
        text-align: right;
    }
    .grid td button
    {
        height: 22px;
    }

    td.desc
    {
        max-width: 150px;
        text-align: left;
        word-break: break-all;
        overflow:auto;
    }

    td.oname
    {
        color:black;
        width: 100px;
        word-break: break-all;
        font-family:monospace;
    }
    td.ovalue
    {
        color:black;
        width: 200px;
        text-align: left;
        word-break: break-all;
        overflow:auto;
        font-size: small;
        font-family:monospace;
    }
    .grid button.bt_oview
    {
        text-align: center;
        width: 65px;
        font-family:monospace;
        font-size: 11px;

        height:36px;
        border: 0;
        padding:0;
        margin:0;
        background: #45556A;
        box-shadow: rgb(11 14 17 / 16%) 0px 2px 8px;
    }


    .red
    {
        color:red;
    }
    .blue
    {
        color:lightblue;
    }
    .green
    {
        color:lightgreen;
    }
    .orange
    {
        color:orange;
    }
    .gray
    {
        color: gray;
    }



    .logo
    {
        width: 100%;
    }
    option
    {
        text-align:center;
        font-family:monospace;
    }
    .olink
    {
        cursor:pointer;
    }


    .btn_svg
    {
        border: 0;
        border-radius:5px;
        height:24px;
        width:24px;
        fill:#ccc;
    }
    .btn_svg:hover
    {
        fill: #cb763a;
        cursor: pointer;
    }
    .btn_choose
    {
        position:relative;
        top: 20px;
        left:0px;

        height: 20px;
        width: 20px;

        font-size: 16px;

        color:white;
        background-color: #415065;
    }
    .bt_set
    {
        width: 52px;
        height:20px;
        border: 0;
        border-radius:5px;
        padding:0;
        margin:0;
        line-height:16px;
    }
    #idChannelInfo1,#idChannelInfo2
    {
        margin:0px 40px;
    }
    #idChannelImg1,#idChannelImg2
    {
        height: 32px;
        width: 32px;
        margin:10px 55px;
    }

    #idConnectWallet button
    {
        height: 40px;
        width:100%;
        margin: 10px 10px;
        border-radius: 5px;
    }



    .ModalDlg
    {
        min-width:300px;
    }
    #idConfirmTitle
    {
        height:20px;
    }
    #idConfirm
    {
        padding:5px 15px;
        margin:0;
        top:50%;
    }

    ::-webkit-scrollbar
    {
        width: 2px;
    }
    ::-webkit-scrollbar-track-piece
    {
        background-color: transparent;
        -webkit-border-radius: 6px;
    }
    ::-webkit-scrollbar-thumb
    {
        background: #73889e;
    }


</style>

<div align="center" style="width:98%">
    <div align="left" style="max-width:800px">

        <div align='center' id="idMain" style="display:none;">

            <menu>
                <item data-ref="mSend" id="mSend">
                    SEND
                </item>

                <item data-ref="mTx" id="mTx">
                    TX
                </item>

                <!--<item data-ref="mInfo" id="mInfo">-->
                <!--    INFO-->
                <!--</item>-->

                <item data-ref="mOwner" id="mOwner">
                    OWNER
                </item>

                <item data-ref="sSign" id="mSign">
                    SIGN
                </item>

            </menu>





            <content data-ref="mInfo">

                <!--Common TERA-ETH Bridge information-->


                <img align="center" class="logo" src="https://terafoundation.org/files/terahub/TeraHub-2.jpg" alt="TERA-HUB">

            </content>

            <content data-ref="mTx" id="idContentMonitor">


                <menu  style="max-width:600px">
                    <item onclick="SetMonitorMode('MY')" id="mMy">
                        MY
                    </item>
                    <!--<item onclick="SetMonitorMode('MYFINISH')">-->
                    <!--    FINISH-->
                    <!--</item>-->
                    <item onclick="SetMonitorMode('ALL')">
                        ALL
                    </item>
                    <item onclick="SetMonitorMode('TOTERA')">
                        TO TERA
                    </item>
                    <item onclick="SetMonitorMode('TOETH')">
                        TO ETH
                    </item>

                    <item onclick="SetMonitorMode('REFUND')">
                        REFUND
                    </item>
                    <item onclick="SetMonitorMode('SLASH')">
                        SLASH
                    </item>

                </menu>

                <BR><button class="update" onclick="UpdateMonitor()">⭮ Update</button>

                <table id="idOrders" class="grid">
                    <tr>

                        <th id="(GetDateOrder(Item))" class="">Date</th>
                        <th id="(GetAmount(Item))" class="bold">Amount</th>
                        <th id="(GetBtStateOrder(Item))">State</th>
                        <th id="(RetHistoryAccount(Item,'AddrTera'))" class="">Addr Tera</th>
                        <th id="(GetDirectOrder(Item))" class="">↔</th>
                        <th id="(GetAddrEth(Item))" class="">Addr Eth</th>
                        <th id="Item.Description" class="desc">Description</th>


                        <th id="Item.ID" class="id">ID</th>
                        <th id="Item.NotaryFee" class="sum bold">Fee Notary</th>
                        <th id="Item.TransferFee" class="sum bold">Fee Transfer</th>
                        <th id="Item.SignArr.length" class="">Notary signs</th>
                        <th id="Item.InTera?1:0">Tera</th>
                        <th id="Item.InEth===null?'-':Item.InEth?Item.InEth:0">Eth</th>
                        <th id="Item.PeriodNum">Period</th>
                    </tr>
                </table>


            </content>

            <content data-ref="mSend" style="max-width:400px">
                <div align="left">
                    <div class="row">
                        <row_cell>
                            <div class="row-head">Asset</div>
                            <select size="1" id="idAsset" class="row-item" onchange="OnSelectCurrency()">
                                <option value="0">Loading...</option>
                            </select>
                        </row_cell>
                    </div>
                    <div class="row_info" id="idAddMetamask">
                        <p>Add <span id="idAddAsset">---</span> to MetaMask </p>
                        <button class="row-item btn_svg" style="margin-left:10px" onclick="AddCoinToMetamask()">
                            <svg viewBox="0 0 16 16" style="height:16px"><path d="M0 7h16v2H0V7z"></path><path d="M9 0v16H7V0h2z"></path></svg>
                        </button>
                    </div>

                    <div class="row">
                        <row_cell class="addr-box">
                            <div class="row-head">From</div>
                            <div class="chain-box">

                                <select size="1" id="idChannel1" class="btn_choose" onchange="ChooseChainFrom()">
                                    <option value="0">Loading...</option>
                                </select>
                                <p id="idChannelInfo1">---</p>
                                <img id="idChannelImg1">


                            </div>
                        </row_cell>
                        <button class="row-item btn_svg" style="margin:55px 0" onclick="SwapChain()">
                            <svg viewBox="0 0 18 18" style="height:18px"><path d="M10.47 1L9.06 2.41l5.1 5.1H0V9.5h14.15l-5.09 5.09L10.47 16l7.5-7.5-7.5-7.5z"></path></svg>
                        </button>
                        <row_cell class="addr-box">
                            <div class="row-head">To</div>
                            <div class="chain-box">

                                <select size="1" id="idChannel2" class="btn_choose" onchange="ChooseChainTo()">
                                    <option value="0">Loading...</option>
                                </select>
                                <p id="idChannelInfo2">---</p>
                                <img id="idChannelImg2">

                            </div>
                        </row_cell>
                    </div>

                    <div class="row_info" id="idAddBSC">
                        <p style="margin-left:10px">If you have not add BSC network in your MetaMask yet, please click
                            <button class="btn_svg" style="width:90px" onclick="ChooseNet('BSC')">Add network</button>and continue</p>
                    </div>
                    <div class="row_info" id="idConnectWallet">
                        <button class="" style="" onclick="ConnectWallet()">Connect Wallet</button>
                    </div>

                    <div>
                        <div id="idRowTera">
                            <div class="row">
                                <row_cell>
                                    <div class="row-head" id="idInfoAddr1">---</div>
                                    <select size="1" id="idAddrTera" class="row-item" onchange="OnSelectAddrTera()">
                                        <option value="0">Loading...</option>
                                    </select>
                                </row_cell>
                            </div>

                            <div class="row_info">
                                <p>Create new account</p>
                                <button class="row-item btn_svg" style="margin-left:10px" onclick="CreateAccount()">
                                    <svg viewBox="0 0 16 16" style="height:16px"><path d="M0 7h16v2H0V7z"></path><path d="M9 0v16H7V0h2z"></path></svg>
                                </button>
                            </div>
                        </div>

                        <div id="idRowEth">
                            <div class="row">
                                <row_cell>
                                    <div class="row-head"><span id="idInfoAddr2">---</span>
                                        <button onclick="SetEthCurAddres()" class="bt_set">
                                            set
                                        </button>
                                    </div>

                                    <input type="string" id="idAddrEth" class="row-item" onchange="SetBalance()">
                                </row_cell>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="idTypeNFT" style="display:none;">
                        <row_cell>
                            <div class="row-head">Choose token:</div>
                            <grid_nft id="idListNFT">
                                <item_nft>Loading...</item_nft>
                            </grid_nft>
                        </row_cell>
                    </div>
                    <div class="row">
                        <row_cell>
                            <div class="row-head">Amount:
                                <button onclick="SetMaxAmount()" class="bt_set">
                                    max
                                </button>
                            </div>
                            <input type="number" id="idAmount" class="row-item amount" style="text-align:right;">
                        </row_cell>

                        <row_cell id="idBlockTrFee" class="marginl10">
                            <div class="row-head">Transfer fee:</div>
                            <input type="number" id="idTransferFee" class="row-item amount" style="text-align:right;width:95%;">
                        </row_cell>
                    </div>

                    <div class="row_info">
                        <p style="margin-left:10px"><span id="idBalance">---</span>
                    </div>

                    <div class="row">
                        <row_cell>
                            <div class="row-head">Description (MEMO):</div>
                            <TEXTAREA id="idDescription" class="row-item" style="height:60px;"></TEXTAREA>
                        </row_cell>
                    </div>
                    <div class="row">
                        <button id="idBtSend" onclick="SendCoins()">SEND</button>
                        <button onclick="ClearSend()">CLEAR</button>
                    </div>
                </div>


                <div align="center" style="font-size: 16px;">
                    Help<BR>
                    <a href="https://t.me/terahub">Telegram channel</a>
                    <a href="https://youtu.be/-kOWXWKadh8">Description video</a>
                    <a href="https://github.com/terablockchain/terahub">Github</a>
                    <!--progr76@gmail.com-->
                </div>

            </content>


            <content data-ref="mOwner">

                <menu>
                    <item data-ref="sSmart">
                        SMART
                    </item>
                    <item data-ref="mLog" id="tlog">
                        Logs
                    </item>

                </menu>

                <div id="idTest1">
                    <button onclick="TestSlashProof()">SlashProof</button>
                    <button onclick="TestExecOrder()">ExecOrder</button>
                </div>
                <BR>Order:<input id="idOrder" style="width:120px" type="number">
                <button onclick="DoGetOrder()">Get order</button>




                <content data-ref="sSmart">
                    <button onclick="SmartGetEmpty()">Empty</button>
                    <button onclick="SmartGetConf()">Get conf</button>
                    <button onclick="SmartSetConf()">Set conf</button>
                    <button onclick="SmartResetOrders()">Reset orders</button>
                    <br>

                    <TEXTAREA id="idSettings" rows="20" cols="40" style="width:99%"></TEXTAREA>
                    <BR>
                    <button onclick="SmartGetProxy()">Get proxy</button>
                    <button onclick="SmartSetProxy()">Set proxy</button>
                </content>

                <content data-ref="mLog">
                    <button onclick="idLogs.value=null">Clear</button>
                    <TEXTAREA id="idLogs" rows="22" cols="40" style="width:99%"></TEXTAREA>
                </content>


            </content>

            <content data-ref="sSign">
                Addr:
                <TEXTAREA id="idPubKey" rows="2" cols="40" style="width:99%"></TEXTAREA>
                Privat key:
                <TEXTAREA id="idPrivKey" rows="3" cols="40" style="display:none; width:99%" onchange="CalcSecret(1);"></TEXTAREA>

                <label for="load-key" class="btfile" style="padding:7px;" onchange="LoadWebDataFromFile('load-key',LoadKeyFromFile)">
                    <input class="hidden" id="load-key" type="file">
                    <span>Load from file</span>
                </label>
                <button id="idStartAuto" onclick="StartAutoSign()">AutoSign</button>



                <button onclick="CalcSecret(1)">Calc Secret</button>
                <button id="idShowPrivKey" onclick="ShowPrivKey()">Show Secret</button>
                <button id="idResetPrivKey" onclick="idPrivKey.value=null;CalcSecret(1)">Reset secret</button>
            </content>

        </div>
    </div>
</div>

<div id="idOrderShow" style="display:none">
    <div style="overflow:auto;max-height:380px;width:100%;">
        <table id="idShow" class="grid">
            <tr>
                <th id="Item.Name" class="oname">Name</th>
                <th id="Item.Value" class="ovalue">Value</th>
            </tr>
        </table>
    </div>
</div>


