
<!--<script src="/file/70823524/0">TAB main-net</script>-->
<script src="/file/7359663/0">TAB test-net</script>
<!--<script src="/file/196/0">TAB local-net</script>-->

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="/smart/283">OrderLib test-net</script>
<script src="/file/8517548/0">OrderLib client part test-net</script>





<script>
    ALL_ACCOUNTS=1;
    var MapCurNum={};


    var OwnerMode;
    var DELTA_REMOVE=50;
    OLib.WORK_DELTA=2;//отступ от краев внутри разрешенного диапазона работы
    OLib.ContractAddr="";
    OLib.EthNetworkId=0;
    OLib.NetMapByGate={};

    var MAX_OLD_ORDER_LENGH=20;

    var TESTMODE=0;

    var glPrivKey;
    var SaveIdArr=["idToken","idBridge","idAddrTera","idAddrEth","idAmount","idTransferFee","idDescription", "idPrivKey"];
    var OrderArr=[];
    var MonitorMode="MY";
    var PrevMonitorMode;
    var MapPending={};
    var SendBtMap={};
    var glSendNum=0;

    var CurrentFormUID=0;




    // ethereum.on('accountsChanged', function (accounts)
    // {
    //     console.log("accountsChanged>",accounts);
    // });

    ethereum.on('chainChanged', function (chainId)
    {
        //console.log("chainChanged>",chainId);
        OLib.DeltaConfUpdate=1;
        OLibClearCahce();
        OLib.EthNetworkId=chainId;
        SetChannelList();

    });

    async function FillEthNetwork()
    {
        OLib.EthNetworkId = await ethereum.request({ method: 'net_version' });
    }
    async function FillEthSmart()
    {
        if(!OLib.ConfTera)
            await GetConfTera({});
        FillGates(OLib.ConfTera);
    }



    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------

    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------

    window.addEventListener('Init',async function ()
    {
        if(SMART.Num===7)
        {
            TESTMODE=1;
            OLib.WORK_PERIOD=1;
        }
        SetVisibleBlock("idTest1",TESTMODE);

        CheckArr();
        LoadValues();

        SmartGetConf();
        PrepareSavingItems();

        var Conf=await GetConfTera();

        if(TESTMODE && (!Conf || !Conf.Common))
        {
            SmartGetEmpty();
            SmartSetConf()
        }

        UpdateOrderList(1,1);

        OLib.DeltaConfUpdate=1;

        FillEthNetwork();
        SetTokenList();

        setInterval(function()
        {
            OLib.DeltaConfUpdate++;
            if(OLib.DeltaConfUpdate>10)
                OLib.DeltaConfUpdate=10;
        },5*1000)
    });




    window.addEventListener('UpdateInfo',function ()
    {
        CheckArr();
        UpdateOrderList();

        SetTokenList();
    });

    window.addEventListener('Event',function(e)
    {
        var Msg=e.detail;
        var Data=Msg.Description;

        if(Msg.Error)
        {
            SetError(Data);
        }
        else
        if(Data.cmd==="AddOrder")
        {
            delete MapPending[Data.UID];
            if(Data.UID===CurrentFormUID && idDescription.value!=="-" && !TESTMODE)
                ClearSend();
        }

        var Str;
        if(typeof Data==="object")
            Str=JSON.stringify(Data,"",4)
        else
            Str=Data;
        idLogs.value=Str+"\n-------\n"+idLogs.value;
        //console.log(Data);

        var Order=Data;
        if(Order.cmd && Order.Data)
            Order=Order.Data;

        if(Order.ID)
        {
            UpdateTeraCache(Order);
            UpdateOrderList(1);
        }


    });

    function CheckArr()
    {
        var TokenId=-1;
        var Gate=GetCurrentGateInfo();
        if(Gate)
        {
            TokenId=Gate.TokenId;
        }

        OwnerMode=0;
        var Arr=[];
        for(var i=0;i<USER_ACCOUNT.length;i++)
        {
            var Item=USER_ACCOUNT[i];
            if(SMART.Owner===Item.Num)
                OwnerMode=1;

            if(SMART.Num!==Item.Value.Smart)
                continue;

            if(Item.Currency===TokenId)
            {
                var Value={value:Item.Num, text:Item.Num+"."+Item.Name+"  "+SUM_TO_STRING(Item.Value,Item.Currency,1)};
                Arr.push(Value);
            }
        }

        SetVisibleBlock("mOwner",OwnerMode);

        FillSelect("idAddrTera",Arr);
    }

    function Round(Sum)
    {
        return Math.floor(Sum*1e9)/1e9;
    }




    //--------------------------------------------------------------------------- ETH Coin
    async function AddCoin()
    {
        var Gate=GetCurrentGateInfo();
        if(!Gate)
            return;

        var GateEth=await GetGateEth(Gate.ID);
        if(!GateEth || GateEth.TokenAddr=="0x0000000000000000000000000000000000000000")
            return SetError("Error token conf");

        var tokenImage;
        if(Gate.TokenName=='TERA')
            tokenImage = 'https://terawallet.org/tera.ico';



        try {
            // wasAdded is a boolean. Like any RPC method, an error may be thrown.
            var wasAdded = await ethereum.request({
                method: 'wallet_watchAsset',
                params: {
                    type: 'ERC20', // Initially only supports ERC20, but eventually more!
                    options: {
                        address: GateEth.TokenAddr, // The address that the token is at.
                        symbol: Gate.TokenName, // A ticker symbol or shorthand, up to 5 chars.
                        decimals: GateEth.Decimals, // The number of decimals in the token
                        image: tokenImage, // A string url of the token logo
                    },
                },
            });
        }
        catch (error)
        {
            console.log(error);
        }
    }

    async function AddChainParameter()
    {
        const data =
            [
                {
                    chainId: "0x"+(97).toString(16), // A 0x-prefixed hexadecimal string
                    chainName: "BNB-TEST",
                    nativeCurrency: {
                        name: "BNB",
                        symbol: "BNB", // 2-6 characters long
                        decimals: 18,
                    },
                    rpcUrls: ["https://data-seed-prebsc-1-s1.binance.org:8545"],
                    //blockExplorerUrls?: string[];
                }
            ];

        var wasAdded = await ethereum.request({method: 'wallet_addEthereumChain',params: data});

        console.log(wasAdded);
    }




    //--------------------------------------------------------------------------- ETH Send

    function FindOrderByID(ID)
    {
        if(ID)
            for(var i=0;i<OrderArr.length;i++)
            {
                var Order=OrderArr[i];
                if(Order.ID===ID)
                {
                    return Order;
                }
            }
        return SetError("Error order ID");
    }

    async function SendIDToEth(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            try
            {
                var Ret=await SendExecOrderEth(Order);
                console.log(Ret);
            }
            catch(e){};
        }
    }



    function ViewOrder(ID)
    {
        var Order=FindOrderByID(ID);
        if(Order)
        {
            console.log(Order);
        }
    }

    async function SendIDToTera(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            SendBtMap["Send"+Order.ID]=1;
            var Order2=GetPureOrder(Order);
            console.log(Order2);
            MSendCall(0,"ExecOrder",GetPureOrder(Order),[],+idAddrTera.value);
        }
    }


    async function SendExecOrderEth(Order)
    {
        var Conf=await GetConfTera();
        if(!Conf || !Conf.Common || !Conf.Common.MinSign)
            return SetError("Error Tera Conf");

        SendBtMap["Send"+Order.ID]=1;
        var Buf=[];
        EncodeOrder(Buf,Order,1,Conf.Common.MinSign);
        console.log("ETH Length:",Buf.length,ToBytes(Buf));
        return SendEth("ExecOrder",ToBytes(Buf));
    }



    async function SendIDToSlash(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order)
        {
            SendBtMap["Slash"+Order.ID]=1;
            var Order2=CopyObjKeys({},Order);
            delete Order2.SignArr;
            var ArrRet=[];
            for(var i=0;i<Order.SignArr.length;i++)
            {
                var Item=Order.SignArr[i];
                if(!Item.Slash)
                {
                    if(IsTera(Order))
                    {
                        Order2.Notary=Item.Notary;
                        MSendCall(0,"SlashProof",Order2,Item.Sign,+idAddrTera.value);
                    }
                    else
                    {
                        var Buf=[];
                        EncodeOrder(Buf,Order,0);

                        var SignStr=GetHexFromArr(Item.Sign);
                        var StrR=SignStr.substr(0,32*2);
                        var StrS=SignStr.substr(32*2,32*2);
                        var StrV=SignStr.substr(64*2,2);

                        var Ret = SendEth("SlashProof",ToBytes(Buf),0,ToBytes(StrR),ToBytes(StrS),ToBytes(StrV));
                        ArrRet.push(Ret);
                    }
                    Item.Slash=1;
                }
            }

            for(var i=0;i<ArrRet.length;i++)
            {
                console.log(await Ret);
                delete OLib.MAP_ETH[ID];
            }
        }
    }
    async function SendIDToRefund(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order && OLib.ConfTera)
        {
            SendBtMap["Refund"+Order.ID]=1;
            if(IsTera(Order))
            {
                MSendCall(0,"CancelOrder",{ID:Order.ID},[],+idAddrTera.value);
            }
            else
            {
                var Ret=await SendEth("CancelOrder",ID);
                console.log(Ret);
                delete OLib.MAP_ETH[ID];
            }
        }
    }

    async function SendIDToSign(ID,btn)
    {
        btn.disabled = true;

        var Order=FindOrderByID(ID);
        if(Order && OLib.ConfTera)
        {
            SendBtMap["Sign"+Order.ID]=1;
            if(IsTera(Order))
            {
                var SignArr=GetSignOrder(Order,glPrivKey);
                MSendCall(0,"NotarySign",{ID:Order.ID, Notary:0},SignArr,+idAddrTera.value);

            }
            else
            {

                var SignStr=GetHexFromArr(GetSignOrder(Order,glPrivKey));
                var StrR=SignStr.substr(0,32*2);
                var StrS=SignStr.substr(32*2,32*2);
                var StrV=SignStr.substr(64*2,2);

                //console.log(StrR,StrS,StrV);

                var Ret=await SendEth("NotarySign",ID,0,ToBytes(StrR),ToBytes(StrS),ToBytes(StrV));
                console.log(Ret);
                delete OLib.MAP_ETH[ID];
            }
        }
    }


    //--------------------------------------------------------------------------- TERA Send


    async function SendCoins()
    {
        await ["idToken","idBridge","idAddrTera","idAddrEth","idAmount"].forEach(function(id)
        {
            if(!$(id).value)
            {
                SetError("Need set "+id.substr(2));
                throw "Error";
            }

        });

        var Conf=await GetConfTera();

        if(!Conf.Common.NotaryArr)
            return SetError("Error Notary dapp params");

        let Order=await FormToOrder(Conf);
        if(!Order)
            return;



        var option=idBridge.options[idBridge.options.selectedIndex];
        DoConfirm("Send "+option.innerText,CreateSendHTML(Order),async function()
        {
            SelectTabMenu("mMonitor");
            SelectTabMenu("mMy");
            SetMonitorMode("MY");

            glSendNum++;
            let UID=Order.AddrTera*1000+(glSendNum%1000);
            Order.UID=UID;
            CurrentFormUID=Order.UID;

            Order.ID=GetCurrentBlockNumByTime()*100000;
            Order.Pending=1;
            Order.SignArr=[];
            MapPending[Order.UID]=Order;

            UpdateOrderList(1);

            if(Order.Mode%2==0)//Mode Eth to Tera
            {
                try
                {
                    var RetSend=await SendAddOrderEth(Order);
                    console.log(RetSend);
                }
                catch(e){};

                delete MapPending[UID];
            }
            else
            {
                if(!MSendCall(+idAddrTera.value,"AddOrder",Order,[],+idAddrTera.value))
                    return;
            }
        });
    }
    function DoConfirm3(a,b,F)
    {
        F();
    }


    async function FormToOrder(Conf)
    {
        if(!Conf)
            Conf=OLib.ConfTera;
        if(!Conf)
            return;


        var Order=
            {
                Mode:(+idBridge.value)%10,
                Gate:Math.floor((+idBridge.value)/10),
                AddrTera:+idAddrTera.value,
                AddrEth:idAddrEth.value,
                Amount:Round(+idAmount.value),
                TransferFee:Round(+idTransferFee.value),
                Description:idDescription.value,
            }



        Order.AddrEth=ToBytes(Order.AddrEth).substr(2);
        Order.NotaryFee=0;

        var Gate;
        var Common;
        if(Order.Mode==1 || TESTMODE)
        {
            Common=Conf.Common;
            Gate=GetCurrentGateInfo();
        }
        else
        {
            Gate=await GetGateEth(Order.Gate);
            Common=await GetCommonEth();
        }
        if(!Gate)
            return;


        var NeedFee=Common.NotaryFee*(Order.Amount+Order.TransferFee);
        Order.NotaryFee=Round(Math.max(NeedFee,Gate.Rate*Common.MinNotaryFee));
        return  Order;
    }

    function CreateSendHTML(Order)
    {
        var Arr=[];
        Arr[(Order.Mode+1)%2]=Order.AddrTera;
        Arr[(Order.Mode)%2]=Order.AddrEth;

        var TokenName=GetTokenByGate(Order.Gate);

        var Str=`
        <DIV align='left'>
        <hr>
        <txtr><txth>From:</txth><txtshort>${Arr[0]}</txtshort></txtr>
        <txtr><txth>To:</txth><txtshort>${Arr[1]}</txtshort></txtr>
        <txtr><txth>Amount:</txth><txtvo>${Order.Amount}</txtvo>
        <txthfee class="${Order.Mode%2==1?'':'hide'}">Transfer:<txtvo>${Order.TransferFee}</txtvo></txthfee><txthfee>Notary:<txtvo>${Order.NotaryFee}</txtvo></txthfee></txtr>
        <txtr><txth>Description:</txth><txtv>${Order.Description}</txtv></txtr>
        <hr>
        <txtr><txth>TOTAL:</txth><txtvo>${Round(Order.Amount+Order.NotaryFee+Order.TransferFee)}</txtvo>${TokenName}</txtr>

        </DIV>`

        return Str;
    }

    function ClearSend()
    {
        ["idAddrTera","idAddrEth","idAmount","idTransferFee","idDescription"].forEach(id => $(id).value="");
    }

    //--------------------------------------------------------------------------- Process Tera orders

    function IsMyOrder(Order)
    {
        if(USER_ACCOUNT_MAP[Order.AddrTera] || USER_ACCOUNT_MAP[Order.AddrEth] || TESTMODE)
            return 1;
        else
            return 0;
    }

    function GetShortAddr(Addr)
    {
        if(Addr.substr(0,2)==="0x")
            Addr=Addr.substr(2);
        return Addr.substr(0,4)+"..."+Addr.substr(Addr.length-4);
    }
    function GetViewOrder(Item)
    {
        var Str=GetShortAddr(Item.AddrEth);
        return "<a class='olink' target='_blank' onclick='ViewOrder(" + Item.ID + ")'>" + Str + "</a>";
    }
    function GetDirectOrder(Order)
    {
        if(IsTera(Order))
            return '<span class="green">→<span>';
        else
            return '<span class="orange">←<span>';

    }
    function Short8(Value)
    {
        if(!Value)
            return "-";
        return Value.substr(0,8);
    }

    function SetStateOrder(Item)
    {
        SetOrderPeriod(Item);

        var Net=OLib.NetMapByGate[Item.Gate];
        if(Net)
            Item.ChainName=Net.ChainName;

        Item.Err=0;

        if(Item.PeriodNum>=4)
        {
            Item.State=Item.Period;
        }
        else
        {
            if(IsTera(Item))
                SetStateOrder1(Item);
            else
                SetStateOrder2(Item);
        }
    }

    function SetStateOrder1(Item)
    {

        if(Item.HashEth && Item.HashTera!==Item.HashEth)
            Item.Err=1;

        if(Item.InEth)
        {

            if(Item.Err)
            {
                if(Item.Process!==200 && Item.PeriodNum>1 && Item.PeriodNum<=3)
                    Item.State="ToSlash";
                else
                    Item.State=Item.Period;
            }

            if(!Item.Err)
            {
                Item.State="Transferred";
                Item.Final=1;
            }
        }
        else
        {
            if(Item.Pending)
                Item.State="Pending";
            else
            if(Item.Process===0 && Item.PeriodNum===2)
                Item.State="ToSign";
            else
            if(Item.Process===1 && Item.InEth!==null)
                Item.State="ToEth";
            else
            if(Item.Process===0 && Item.PeriodNum>=3)//Checking
                Item.State="ToRefund";
            else
            if(Item.Process===100)
            {
                Item.State="Refunded";
                Item.Final=1;
            }
            else
                Item.State=Item.Period;
        }
    }

    function SetStateOrder2(Item)
    {

        if(Item.HashTera && Item.HashTera!==Item.HashEth)
            Item.Err=1;

        if(Item.InTera)
        {

            if(Item.Err)
            {
                if(Item.Process!==200 && Item.PeriodNum>1 && Item.PeriodNum<=3)
                    Item.State="ToSlash";
                else
                    Item.State=Item.Period;
            }

            if(!Item.Err)
            {
                Item.State="Transferred";
                Item.Final=1;
            }
        }
        else
        {
            if(Item.Pending)
                Item.State="Pending";
            else
            if(Item.Process===0 && Item.PeriodNum===2)
                Item.State="ToSign";
            else
            if(Item.Process===1 && !Item.InTera)
                Item.State="ToTera";
            else
            if(Item.Process===0 && Item.PeriodNum>=3)//Checking
                Item.State="ToRefund";
            else
            if(Item.Process===100)
            {
                Item.State="Refunded";
                Item.Final=1;
            }
            else
                Item.State=Item.Period;
        }
    }

    function GetBtActOrder(Item)
    {

        //Process
        var Str="-";
        var CheckEth=0;
        var Arr;
        if(Item.State==="ToEth")
        {
            CheckEth=2;
            Arr=["Send","SendIDToEth","green"];
        }
        else
        if(Item.State==="ToSlash" && Item.PeriodNum>=3)
        {
            CheckEth=1;
            Arr=["Slash","SendIDToSlash","red"];
        }
        else
        if(Item.State==="ToRefund")
        {
            CheckEth=1;
            Arr=["Refund","SendIDToRefund","orange"];
        }
        else
        if(Item.State==="ToSign" && OwnerMode)
        {
            CheckEth=1;
            Arr=["Sign","SendIDToSign","blue"];
        }
        else
        if(Item.State==="ToTera")
        {
            Arr=["Send","SendIDToTera","green"];
        }

        if(CheckEth && OLib.WasMetaMaskInstalled)
        {
            if(CheckEth==2 || CheckEth==1 && !IsTera(Item))
            {
                var Net=OLib.NetMapByGate[Item.Gate];
                if(!Net || Net.EthNetworkId!=OLib.EthNetworkId)
                    return Str;
            }
        }

        if(Arr)
        {
            var Name=Arr[0];
            var Method=Arr[1];
            var color=Arr[2];
            if(SendBtMap[Name+Item.ID])
                color="gray";


            Str='<button class="btaction '+color+'" onclick="'+Method+'('+Item.ID+',this)">'+Name+'</button>';
        }


        return Str;
    }
    function ColoredAmount(Item)
    {
        var Str=Item.Amount;
        if(Item.Err)
            Str="<span class='red'>"+Str+"</span>"
        return Str;
    }




    //--------------------------------------------------------------------------- List orders
    async function UpdateOrderList(OnlyTera,bInit)
    {
        var Map={};

        //Pending
        for(var UID in MapPending)
        {
            var Order=MapPending[UID];
            Map[Order.ID]=Order;
        }


        var Arr;
        Arr=await GetOrderListTera(OnlyTera);
        for(var i=0;i<Arr.length;i++)
        {
            var Order=Arr[i];
            Order.InTera=1;
            Order.HashTera=GetHexFromArr(GetOrderHash(Order));
            if(!Order.InEth)
                Order.InEth=(bInit)?null:0;
            Map[Order.ID]=Order;
        }


        //Eth
        if(!OnlyTera)
        {
            Arr=await GetOrderListEth();
            for(var i=0;i<Arr.length;i++)
            {
                var Order;
                var OrderEth=Arr[i];
                var Order=Map[OrderEth.ID];
                if(!Order)
                {
                    Map[OrderEth.ID]=OrderEth;
                    Order=OrderEth;
                }
                SetAttrEthOrder(Order,OrderEth);
            }
        }
        Arr=[];
        for(var ID in Map)
        {
            var Order=Map[ID];
            //Order.Num=1e12-Order.ID;
            Order.Num=Order.ID;

            SetStateOrder(Order);
            Order.Token=GetTokenByGate(Order.Gate);

            Arr.push(Order);
        }

        Arr.sort(function(a,b){return a.ID-b.ID;})


        OrderArr=Arr;
        ViewMonitor();

    }
    async function SetAttrEthOrder(Order,OrderEth)
    {
        Order.InEth=1;
        Order.HashEth=GetHexFromArr(GetOrderHash(OrderEth));
        Order.EthNextID=OrderEth.NextID;
        Order.EthPrevID=OrderEth.PrevID;
        if(!OrderEth.NotaryFee)
            OrderEth.NotaryFee=0;

        if(!IsTera(Order))
            Order.NotaryFee=OrderEth.NotaryFee;
        //Order.ETH=OrderEth;

    }





    function ViewMonitor()
    {
        var Arr=[];
        if(MonitorMode==="ALL")
            Arr=OrderArr;
        else
            for(var i=0;i<OrderArr.length;i++)
            {
                var Item=OrderArr[i];
                if(Item.State===undefined)
                    console.log(Item);
                if(Item.PeriodNum>=4)
                    continue;

                // if(MonitorMode==="MY" && !Item.Final && IsMyOrder(Item))
                //     Arr.push(Item);
                // else
                // if(MonitorMode==="MYFINISH" && Item.Final && IsMyOrder(Item))
                //     Arr.push(Item);
                if(MonitorMode==="MY" && IsMyOrder(Item))
                    Arr.push(Item);
                else
                if(MonitorMode==="SLASH" && Item.State==="ToSlash")
                    Arr.push(Item);
                else
                if(MonitorMode==="TOETH" && Item.State==="ToEth")
                    Arr.push(Item);
                else
                if(MonitorMode==="TOTERA" && Item.State==="ToTera")
                    Arr.push(Item);
                else
                if(MonitorMode==="REFUND" && Item.State==="ToRefund")
                    Arr.push(Item);


            }
        //SetGridData(Arr,"idOrders",undefined,MonitorMode!==PrevMonitorMode,0);
        SetGridData(Arr,"idOrders",0,1,1);
        PrevMonitorMode=MonitorMode;
    }

    function SetMonitorMode(Str)
    {
        MonitorMode=Str;
        ViewMonitor();
    }

    function SetEthCurAddres()
    {
        idAddrEth.value=OLib.EthAddrFrom;
        SaveValues();
    }

    function GetCurrentGateInfo()
    {
        var Data=MapCurNum[idToken.value];
        if(!Data)
            return;

        var Gate=Data.Gates[Math.floor((+idBridge.value)/10)];
        return Gate;
    }

    function GetTokenByGate(Gate)
    {
        if(!OLib.ConfTera)
            return "";
        var Item=OLib.ConfTera.Gates[Gate];
        if(Item)
            return Item.TokenName;
        else
            return "";
    }

    function UpdateMapCurNum(Conf)
    {
        //console.log(Conf.Gates);
        var Count=0;
        MapCurNum={};
        for(var key in Conf.Gates)
        {
            var Item=Conf.Gates[key];
            if(!Item.Pause && Item.Rate)
            {
                var Data=MapCurNum[Item.TokenId];
                if(!Data)
                {
                    Data={Gates:{},Name:Item.TokenName};
                    MapCurNum[Item.TokenId]=Data;

                    if(!Data.Name)
                        Data.Name=CurrencyName(Item.TokenId);

                }
                Data.Gates[key]=Item;
                Count++;
            }
        }
        return Count;
    }

    var WasSetTokenList=0;
    async function SetTokenList()
    {
        if(WasSetTokenList)
            return;

        var Conf=await GetConfTera();
        if(!Conf)
            return;

        if(!UpdateMapCurNum(Conf))
            return;

        var Arr=[];
        for(var key in MapCurNum)
        {
            var Item=MapCurNum[key];
            var Value={value:key, text:Item.Name};
            Arr.push(Value);
        }

        FillSelect("idToken",Arr);
        SetChannelList();
        WasSetTokenList=1;


    }
    async function SetChannelList()
    {
        if(!OLib.EthNetworkId)
            await FillEthNetwork();


        var Data=MapCurNum[idToken.value];
        if(!Data)
        {
            idBridge.options.length=0;
            return;
        }


        var Arr=[];
        for(var key in Data.Gates)
        {
            var Item=Data.Gates[key];
            Arr.push({value:(+key)*10+1, text: "TERA → "+Item.ChainName});
            var Item2={value:(+key)*10+2, text: Item.ChainName+" → TERA", disabled:Item.EthNetworkId!=OLib.EthNetworkId};
            if(Item2.disabled)
                Item2.text += " - need connect";
            Arr.push(Item2);
        }
        FillSelect("idBridge",Arr);

        for(var i=0;i<Arr.length;i++)
        {
            idBridge.options[i].disabled=Arr[i].disabled;
        }

        OnSelectBridge();
        CheckArr();
    }


    function CreateAccount()
    {
        var Gate=GetCurrentGateInfo();
        if(!Gate)
            return;
        CreateNewAccount(Gate.TokenId);
    }

    async function SetVisibleAddCoin()
    {
        var bView=0;
        var Gate=GetCurrentGateInfo();
        if(Gate)
        {
            var GateEth=await GetGateEth(Gate.ID,1);
            if(GateEth && GateEth.TokenAddr!="0x0000000000000000000000000000000000000000")
                bView=1;
        }

        SetVisibleBlock("idAddMetamask",bView);
    }

    async function OnSelectToken()
    {
        SetChannelList();
        SetVisibleAddCoin();
    }
    async function OnSelectBridge()
    {
        SetVisibleBlock("idBlockTrFee",idBridge.value%2==1);
        SetVisibleAddCoin();
    }


    //--------------------------------------------------------------------------- Owner smart
    function SmartGetEmpty()
    {
        var Params=
            {
                EthSmartAddr:"",
                SignLib:0,
                Common:
                    {
                        Pause:0,
                        SignPeriod:14400,//период для подписи (в блоках)
                        TransferPeriod:28800,//устаревание ордеров (в блоках)

                        //комиссии за подпись (в Терах)
                        NotaryFee:0.01,
                        MinNotaryFee:0,
                        MinDeposit:100000, //депозит в Терах

                        //подписанты (валидаторы)
                        NotaryArr:[{Addr:"0000000000000000",AccDeposit:0,SumDeposit:0, CanSign:1, BlockFrom:0, BlockTo:0, Gates:[1,2,3]}],
                        MinSign:1,//требуемое минимальное число подписей

                        //штрафные санкции
                        SlashRate:1,
                        MinSlash:1000,

                    },
                Blockchains:
                    {
                        "NAME"://имя блокчейна
                            {
                                EthNetworkId:0,//eth номер сети
                                EthSmartAddr:"",//адрес смарт-контракта
                                OrderEnum:0,//глобальный номер блокчейна - влияет на создание ID ордера (в наших терминах: 0=Tera, 1=Eth, 2=BSC, до 99)
                            }
                    },
                Gates:
                    {
                        "0":
                            {
                                ID:0,//глобальный уникальный номер канала
                                BlockchainID:0,
                                OrderEnum:0,//глобальный номер блокчейна - влияет на создание ID ордера (в наших терминах: 0=Tera, 1=Eth, 2=BSC, до 99)
                                ChainName:"NAME",
                                //EthNetworkId:0,
                                TokenId:0,//номер валюты (номер даппа)
                                TokenName:"",
                                TokenAcc:0,//номер счета с монетами
                                Rate:1,//курс к Тера для расчета слэшинга или минимальной комисии
                                Pause:0,
                            }
                    },
                Orders:
                    {
                        HeadID:0,
                        TailID:0,

                        NewOrderID:0,
                        WorkNum:0,
                    }

            };


        if(TESTMODE)
        {
            Params.SignLib=283;
            Params.Common.SignPeriod=100;
            Params.Common.TransferPeriod=200;
            Params.EthSmartAddr="";//"0xbc4d60aa28ab4e8f51c469917a7d2b5cba46c740";
            Params.Common.NotaryArr=[{Addr:"5201A60DE4328750EC18C6BEA49B2DA10A82013F",AccDeposit:0,SumDeposit:110000, CanSign:1, BlockFrom:0, BlockTo:0, Gates:[1,2,3]}];
            Params.Blockchains=
                {
                    "ETH":
                        {
                            EthNetworkId:4,//main 1
                            EthSmartAddr:"",
                            OrderEnum:1,
                        },
                    "BSC":
                        {
                            EthNetworkId:97,//main 56
                            EthSmartAddr:"",
                            OrderEnum:2,
                        }
                };

            Params.Gates=
                {
                    "1":
                        {
                            ID:1,
                            ChainName:"ETH",
                            TokenId:0,
                            TokenName: "TERA",
                            TokenAcc:107,
                            Rate:1,
                            Pause:0
                        },
                    "2":
                        {
                            ID:2,
                            ChainName:"BSC",
                            TokenId:0,
                            TokenName: "TERA",
                            TokenAcc:107,
                            Rate:1,
                            Pause:0
                        },
                    "3":
                        {
                            ID:3,
                            ChainName:"ETH",
                            TokenId:1,
                            TokenName:"USD",
                            TokenAcc:101,
                            Rate:0.03,
                            Pause:0
                        },
                }
        }
        idSettings.value=JSON.stringify(Params,"",4);
    }

    function SmartSetConf()
    {
        if(!idSettings.value)
            return SetError("Need set params");
        var Conf=JSON.parse(idSettings.value);
        MSendCall(0,"SetCommon",Conf,[],SMART.Owner);
    }
    function SmartResetOrders()
    {
        MSendCall(0,"ResetOrders",{},[],SMART.Owner);
    }




    async function SmartGetConf()
    {
        OLibClearCahce();

        var Conf=await GetConfTera();
        if(Conf)
            for(var key in Conf.Gates)
            {
                var Item=Conf.Gates[key];
                delete Item.EthNetworkId;
                delete Item.EthSmartAddr;
                delete Item.OrderEnum;
            }

        idSettings.value=JSON.stringify(Conf,"",4);
    }

    async function SmartGetProxy()
    {
        var Data=await CallTeraProxy(0,"GetProxy",{});
        console.log("Data",Data);
        idSettings.value=JSON.stringify(Data,"",4);
    }
    function SmartSetProxy()
    {
        if(!idSettings.value)
            return SetError("Need set params");
        var Params=JSON.parse(idSettings.value);
        MSendCall(0,"SetProxy",Params,[],SMART.Owner);
    }




    //--------------------------------------------------------------------------- Private key support
    function SetPubKey()
    {
        glPubKey=SignLib.publicKeyCreate(glPrivKey, 0);
        glAddr=GetHexFromArr(GetAddrFromPubKey(glPubKey));
        idPubKey.value=glAddr;
        SaveValues();
    }

    function CalcSecret()
    {
        idPrivKey.value=idPrivKey.value.trim();
        if(idPrivKey.value)
        {
            glPrivKey=GetArrFromHex(idPrivKey.value);
            SetPubKey();
        }
        else
        {
            var PubKey=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2];

            ComputeSecret(PubKey,function (ArrSecret)
            {
                glPrivKey=ArrSecret;
                SetPubKey();
            },+idAddrTera.value);
        }

    }
    function ShowPrivKey()
    {
        idPrivKey.value=GetHexFromArr(glPrivKey);
        SetPubKey();


        SetVisibleBlock("idPrivKey",1);
        setTimeout(function()
        {
            SetVisibleBlock("idPrivKey",0);
        },10*1000);
    }

    //--------------------------------------------------------------------------- Saving support
    function SaveValues()
    {
        CurrentFormUID=0;
        SaveToStorageByArr(SaveIdArr);
    }
    function LoadValues()
    {
        LoadFromStorageByArr(SaveIdArr,function (Key)
        {
            OnSelectBridge();

            if(OwnerMode)
                CalcSecret();

            SetChannelList();

        },1);
    }
    function PrepareSavingItems()
    {
        for(var n = 0; n < SaveIdArr.length; n++)
        {
            var Item = $(SaveIdArr[n]);
            Item.addEventListener("change",SaveValues);
        }
    }




    //--------------------------------------------------------------------------- TEST MODE
    var TestNum=1;
    function GetTestOrder()
    {

        TestNum+=2;
        var AddrTo = new Uint8Array(20);
        window.crypto.getRandomValues(AddrTo);

        var Order={Gate:1, AddrTera:100, AddrEth:AddrTo, TokenID:[], Amount:random(1000),TransferFee:3, NotaryFee:1, Description:"Super test "+TestNum,  Process:0,PrevID:0,NextID:0};
        Order.AddrEth=GetHexFromArr(Order.AddrEth);
        return Order;
    }

    var LastTestOrder;
    function TestSlashProof()
    {

        var Order;
        if(LastTestOrder)
            Order=LastTestOrder;
        else
        {
            Order=GetTestOrder();
            Order.Amount=1;
            Order.TransferFee=0;
            Order.Gate=3;
            var BlockNum=INFO.CurBlockNum-OLib.ConfTera.Common.SignPeriod-5;
            Order.ID=BlockNum*100000;
            LastTestOrder=Order;
        }

        var SignArr=GetSignOrder(Order,glPrivKey);
        Order.Notary=0;
        MSendCall(0,"SlashProof",Order,SignArr,+idAddrTera.value);
    }

    var LastTestOrder2;
    function TestExecOrder()
    {
        var Order;
        if(LastTestOrder2)
            Order=LastTestOrder2;
        else
        {
            Order=GetTestOrder();
            var BlockNum=INFO.CurBlockNum-5;
            Order.ID=BlockNum*100000+1000*1;
            LastTestOrder2=Order;
        }

        var SignArr=GetSignOrder(Order,glPrivKey);

        Order.SignArr=[{Notary:0,Slash:0,Sign:SignArr}];
        MSendCall(0,"ExecOrder",Order,[],+idAddrTera.value);
    }

    function OpenHistoryPage(Num)
    {
        OpenLink("/history.html#"+Num);
    }


</script>




<style>
    :root
    {
        --colorTabB1: rgba(255, 255, 255, 0.6);
        --colorTabB2: #53687e;
        --colorTabB3: #2a3446;
    }

    body
    {
        background-color: #415065;
        color: white;
    }

    input
    {
        width: 70px;
    }

    button
    {
        height: 26px;
        width: 95px;
        margin: 5px;
        color:white;
        background-color: #2E3857;
        border: 1px solid #888;
    }
    button[disabled]
    {
        color: gray;
        cursor:none;
    }

    button:hover
    {
        color: #cb763a;
        cursor: pointer;
    }
    button[disabled]:hover
    {
        color: gray;
        cursor:none;
    }
    .btaction
    {
        width: 70px;
        padding:0;
        margin:0;
        height:26px;
    }
    .btlist
    {
        width: 150px;
        height:40px;
        margin:10px 2px 30px 2px;
    }


    .row
    {
        margin: 10px 5px;
        font-size: 16px;

        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: end;
        -webkit-align-items: flex-end;
        -ms-flex-align: end;
        align-items: flex-end;
    }

    row_cell
    {
        width:99%;
    }

    .row-head
    {
        display: block;
        margin: 2px;
        text-align: left;
    }
    .row-item
    {
        background-color2: #CCC;
        margin: 2px;
        padding:0px;
        height:30px;
        width:99%;
    }
    .amount
    {
        color:#1e21cb;
        font-weight: bold;
    }
    .row2
    {
        display: flex;
        margin: 10px 5px;
        font-size: 16px;
    }

    .marginl10
    {
        margin-left:10px;
    }

    txtr
    {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        margin: 5px;
    }
    txth
    {
        font-weight: bold;
    }
    txthfee
    {
        font-weight: normal;
        font-size: 12px;
    }

    txtv
    {
        margin-left: 5px;
    }
    txtvo
    {
        margin-left: 5px;
        color:#E9764B;
        font-weight: bold;
        padding: 0 5px;
    }
    txtshort
    {
        margin-left: 5px;
        font-size: 12px;
        padding-top:3px;
    }

    #idConfirm
    {
        background-color:#DBE2F8;
        max-width: 300px;
    }
    #idConnect
    {
        height:50px;
        width:200px;
    }

    .hide
    {
        display: none;
    }


    /*Списки*/
    table
    {
        border-collapse: collapse;
        width:100%;
        max-width: 800px;
        margin-top:5px;

    }
    .grid th
    {
        color2:lightgray;
    }

    .grid th, .grid td
    {
        border: 1px solid #576B83;
        padding: 4px;
    }
    .grid td
    {
        color:lightgray;
        width: 60px;
        vertical-align:top;
    }
    .grid td.sum
    {
        text-align: right;
    }


    .red
    {
        color:red;
    }
    .blue
    {
        color:lightblue;
    }
    .green
    {
        color:lightgreen;
    }
    .orange
    {
        color:orange;
    }
    .gray
    {
        color: gray;
    }

    td.desc
    {
        max-width: 150px;
        text-align: left;
        word-break: break-all;
        overflow:auto;
    }

    .set
    {
        width: 18px;
        border:0;
        padding:0;
        margin:0;
        height:20px;
    }

    .logo
    {
        width: 100%;
    }
    option
    {
        text-align:center;
        font-family:monospace;
    }
    .olink
    {
        cursor:pointer;
    }

</style>

<div align="center" style="width:98%">
    <div align="left" style="max-width:800px">

        <div align='center' id="idMain" style="display:none;">

            <menu>
                <item data-ref="mMonitor" id="mMonitor">
                    MONITOR
                </item>
                <item data-ref="mSend" id="mSend">
                    SEND
                </item>
                <item data-ref="mInfo" id="mInfo">
                    INFO
                </item>

                <item data-ref="mOwner" id="mOwner">
                    OWNER
                </item>

            </menu>





            <content data-ref="mInfo">

                <!--Common TERA-ETH Bridge information-->


                <img align="center" class="logo" src="https://terafoundation.org/files/terahub/TeraHub-2.jpg" alt="TERA-HUB">
                <div align="center">
                    <a href="https://t.me/terahub">Telegram channel</a>
                    <a href="https://youtu.be/-kOWXWKadh8">Description video</a>
                    <a href="https://github.com/terablockchain/terahub">Github</a>
                    <!--progr76@gmail.com-->
                </div>

            </content>

            <content data-ref="mMonitor">


                <menu  style="max-width:600px">
                    <item onclick="SetMonitorMode('MY')" id="mMy">
                        MY
                    </item>
                    <!--<item onclick="SetMonitorMode('MYFINISH')">-->
                    <!--    FINISH-->
                    <!--</item>-->
                    <item onclick="SetMonitorMode('ALL')">
                        ALL
                    </item>
                    <item onclick="SetMonitorMode('TOTERA')">
                        TO TERA
                    </item>
                    <item onclick="SetMonitorMode('TOETH')">
                        TO ETH
                    </item>

                    <item onclick="SetMonitorMode('REFUND')">
                        REFUND
                    </item>
                    <item onclick="SetMonitorMode('SLASH')">
                        SLASH
                    </item>

                </menu>


                <table id="idOrders" class="grid">
                    <tr>

                        <th id="Item.ChainName">Net</th>
                        <th id="(GetBtActOrder(Item))">Action</th>
                        <th id="Item.State">State</th>
                        <th id="(RetHistoryAccount(Item,'AddrTera'))" class="">Addr Tera</th>
                        <th id="(GetDirectOrder(Item))" class="">↔</th>
                        <th id="(GetViewOrder(Item))" class="">Addr Eth</th>

                        <th id="(ColoredAmount(Item))" class="sum bold">Amount</th>
                        <!--<th id="Item.Gate">Gate</th>-->
                        <th id="Item.TransferFee" class="sum bold">Fee Transfer</th>
                        <th id="Item.NotaryFee" class="sum bold">Fee Notary</th>
                        <th id="Item.Token" class="">Token</th>

                        <th id="Item.Description" class="desc">Description</th>
                        <th id="Item.SignArr.length" class="">Notary signs</th>

                        <!--<th id="Short8(Item.HashTera)" class="hash">Tera</th>-->
                        <!--<th id="Short8(Item.HashEth)" class="hash">Eth</th>-->
                        <th id="Item.ID" class="id">ID</th>
                        <!--<th id="Item.NextID" class="id">Next</th>-->
                        <!--<th id="Item.EthPrevID!==undefined?Item.EthPrevID:'-'" class="id">Eth Prev</th>-->
                        <!--<th id="Item.EthNextID!==undefined?Item.EthNextID:'-'" class="id">Eth Next</th>-->

                        <th id="Item.InTera?1:0">Tera</th>
                        <th id="Item.InEth===null?'-':Item.InEth?Item.InEth:0">Eth</th>
                        <th id="Item.PeriodNum">Period</th>
                        <!--<th id="Item.Process">Process</th>-->
                    </tr>
                </table>


            </content>

            <content data-ref="mSend" style="max-width:400px">
                <div align="left">
                    <div class="row">
                        <row_cell style="width:120px">
                            <div class="row-head">Token:</div>
                            <select size="1" id="idToken" class="row-item" style="width: 120px" onchange="OnSelectToken()">
                                <option value="0">Loading...</option>
                            </select>
                        </row_cell>
                        <row_cell class="marginl10" style="width:120px;">
                            <div class="row-head">Bridge:</div>
                            <select size="1" id="idBridge" class="row-item" style="width: 120px" onchange="OnSelectBridge()">
                                <option value="0">Loading...</option>
                            </select>
                        </row_cell>

                        <button id="idAddMetamask" class="row-item" style="width:180px;" onclick="AddCoin()">Add to Metamask...</button>

                    </div>
                    <div class="row">
                        <row_cell>
                            <div class="row-head">Address Tera:</div>
                            <select size="1" id="idAddrTera" class="row-item">
                                <option value="0">Loading...</option>
                            </select>
                        </row_cell>
                        <button class="row-item" style="width:120px; " onclick="CreateAccount()">New account</button>
                    </div>
                    <div class="row">
                        <row_cell>
                            <div class="row-head">Address Eth:
                                <button onclick="SetEthCurAddres()" class="set">
                                    <img src="./img/load.svg">
                                </button>
                            </div>

                            <input type="string" id="idAddrEth" class="row-item">
                        </row_cell>
                    </div>

                    <div class="row">
                        <row_cell>
                            <div class="row-head">Amount:</div>
                            <input type="number" id="idAmount" class="row-item amount" style="text-align:right;">
                        </row_cell>

                        <row_cell id="idBlockTrFee" class="marginl10">
                            <div class="row-head">Transfer fee:</div>
                            <input type="number" id="idTransferFee" class="row-item amount" style="text-align:right;width:95%;">
                        </row_cell>
                    </div>

                    <div class="row">
                        <row_cell>
                            <div class="row-head">Description:</div>
                            <TEXTAREA id="idDescription" class="row-item" style="height:60px;"></TEXTAREA>
                        </row_cell>
                    </div>
                    <div class="row">
                        <button onclick="SendCoins()">SEND</button>
                        <button onclick="ClearSend()">CLEAR</button>
                    </div>
                </div>

            </content>


            <content data-ref="mOwner">

                <menu>
                    <item data-ref="sSmart">
                        SMART
                    </item>
                    <item data-ref="sSign">
                        SIGN
                    </item>
                    <item data-ref="mLog" id="tlog">
                        Logs
                    </item>

                </menu>

                <div id="idTest1">
                    <button onclick="TestSlashProof()">SlashProof</button>
                    <button onclick="TestExecOrder()">ExecOrder</button>
                    <button onclick="AddChainParameter()">BNB-TEST</button>
                </div>


                <content data-ref="sSmart">
                    <button onclick="SmartGetEmpty()">Empty</button>
                    <button onclick="SmartGetConf()">Get conf</button>
                    <button onclick="SmartSetConf()">Set conf</button>
                    <button onclick="SmartResetOrders()">Reset orders</button>
                    <br>

                    <TEXTAREA id="idSettings" rows="20" cols="40" style="width:99%"></TEXTAREA>
                    <BR>
                    <button onclick="SmartGetProxy()">Get proxy</button>
                    <button onclick="SmartSetProxy()">Set proxy</button>
                </content>

                <content data-ref="mLog">
                    <button onclick="idLogs.value=null">Clear</button>
                    <TEXTAREA id="idLogs" rows="22" cols="40" style="width:99%"></TEXTAREA>
                </content>

                <content data-ref="sSign">
                    Addr:
                    <TEXTAREA id="idPubKey" rows="2" cols="40" style="width:99%"></TEXTAREA>
                    Privat key:
                    <TEXTAREA id="idPrivKey" rows="3" cols="40" style="display:none; width:99%" onchange="CalcSecret();"></TEXTAREA>
                    <button onclick="CalcSecret()">Calc Secret</button>
                    <button onclick="ShowPrivKey()">Show Secret</button>
                    <button onclick="idPrivKey.value=null;CalcSecret()">Reset secret</button>
                </content>

            </content>



        </div>
    </div>
</div>



