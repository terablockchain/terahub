<!--<script src="/file/70823524/0">TAB main-net</script>-->
<script src="/file/7359663/0">TAB test-net</script>
<!--<script src="/file/196/0">TAB local-net</script>-->

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="/smart/215">OrderLib test-net</script>
<script src="/file/8236012/0">OrderLib client part test-net</script>



<script>
    ALL_ACCOUNTS=1;
    OLib.WORK_DELTA=2;//отступ от краев внутри разрешенного диапазона работы
    var TESTMODE=0;
    var MAX_OLD_ORDER_LENGH=20;

    var glPrivKey,glPubKey,glAddr;
    var glInfo;
    var glNotaryNum=-1;
    var WorkStruct={};
    var SaveIdArr=["idCurAccount","idChannel","idPrivKey","idAutoRun"];



    //---------------------------------------------------------------------------
    //---------------------------------------------------------------------------

    window.addEventListener('Init',function ()
    {
        if(SMART.Num===7)
            TESTMODE=1;

        PrepareSavingItems();
        CheckArr();
        LoadValues();
        CalcSecret();
        GetChannel();

        setInterval(AutoRun,10*1000);
    });

    window.addEventListener('UpdateInfo',function ()
    {
        CheckArr();
    });

    window.addEventListener('Event',function(e)
    {
        var Msg=e.detail;
        var Data=Msg.Description;

        if(Msg.Error)
        {
            SetError(Data);
        }
        var Str;
        if(typeof Data==="object")
            Str=JSON.stringify(Data,"",4)
        else
            Str=Data;
        idLogs.value=Str+"\n-------\n"+idLogs.value;

        UpdateTeraCache(Data);

    });


    function CheckArr()
    {
        var bOwner=0;
        var Arr=[];
        for(var i=0;i<USER_ACCOUNT.length;i++)
        {
            var Item=USER_ACCOUNT[i];
            if(SMART.Owner===Item.Num)
                bOwner=1;

            if(Item.Currency!==0)
                continue;

            var Value={value:Item.Num, text:Item.Num+"."+Item.Name+"  "+SUM_TO_STRING(Item.Value,Item.Currency,1)};
            Arr.push(Value);


        }

        SetVisibleBlock("mOwner",bOwner);
        SetVisibleBlock("mTest",bOwner);


        FillSelect("idCurAccount",Arr);

    }


    //--------------------------------------------------------------------------- TERA PART redefinition
    async function GetConfTera()
    {
        glNotaryNum=-1;
        OLib.ConfTera={NotarySmartAcc:SMART.Account, Channel:+idChannel.value};
        var Channel=await CallTeraProxy(0,"GetChannel",{Channel:OLib.ConfTera.Channel?OLib.ConfTera.Channel:SMART.Account});
        if(Channel)
        {
            OLib.ConfTera.NOTARY=Channel;

            //проверка что имеем право подписывать
            for(var i=0;i<Channel.NotaryArr.length;i++)
            {
                if(GetHexFromArr(Channel.NotaryArr[i].Addr)===glAddr)
                    glNotaryNum=i;
            }

        }
        glInfo=Channel;

        //console.log("glNotaryNum=",glNotaryNum);


        return OLib.ConfTera;
    }

    function AutoRun()
    {
        if(!idAutoRun.checked)
            return;

        DoSignList();
        DoClearList();
    }




    //--------------------------------------------------------------------------- Test mode
    var TestNum=0;
    function GetTestOrder()
    {
        if(!glInfo)
        {
            GetEmpty();
            SetChannel();
            DoOrderList();
        }

        TestNum++;
        var AddrTo = new Uint8Array(20);
        window.crypto.getRandomValues(AddrTo);
        var Order={Channel:idChannel.value, TestTo:SMART.Account,TestSum:3, AddrTera:(10+random(1000)), AddrEth:AddrTo, Amount:random(1000),TransferFee:3, Description:"Super test "+TestNum};
        Order.AddrEth=GetHexFromArr(Order.AddrEth);
        return Order;
    }
    function AddNew()
    {
        var Order=GetTestOrder();
        //Order.AddrEth=GetHexFromArr(Order.AddrEth);
        MSendCall(+idCurAccount.value,"RunOrder",Order,[],SMART.Owner);
    }

    var LastTestOrder;
    function SlashProof()
    {
        if(!glInfo)
            return ;

        var Order;
        if(LastTestOrder)
            Order=LastTestOrder;
        else
        {
            Order=GetTestOrder();
            var BlockNum=INFO.CurBlockNum-glInfo.SignPeriod-5;
            Order.ID=BlockNum*1000;
        }

        var SignArr=GetSignOrder(Order,glPrivKey);
        Order.Notary=0;
        MSendCall(0,"SlashProof",Order,SignArr,+idCurAccount.value);
    }

    async function DoOrderList()
    {
        var Arr=await GetOrderListTera(0,1);
        console.log(Arr);
    }

    function DoCancelOrder(ID)
    {
        MSendCall(SMART.Account,"CancelOrder",{ID:ID},[],+idCurAccount.value);
    }
    function DoGetOrder(ID)
    {
        MStaticCall(0,"GetOrder",{ID:ID},[],function (Err,Value)
        {
            if(Err)
                SetError(Value);

            // if(Err || !Value)
            //     return;
            console.log(Value);
        });
    }

    function DoDeposit()
    {
        MSendCall(+idCurAccount.value,"RunDeposit",{TestTo:SMART.Account,TestSum:100, Channel:idChannel.value,Notary:glNotaryNum},[],SMART.Owner);
    }
    function DoWithdraw()
    {
        MSendCall(+idCurAccount.value,"RunWithdraw",{TestTo:SMART.Account, Channel:idChannel.value,Notary:glNotaryNum,Amount:100,},[],SMART.Owner);
    }


    //--------------------------------------------------------------------------- Owner smart
    function SmartGetEmpty()
    {
        var Params=
            {
                GetOrder:0,
                SetChannel:0,
                GetChannel:0,
                NotarySign:0,
                SlashProof:0,
                ClearOrderList:0,
                CancelOrder:0,

                CommonNum:0,
            };
        idList2.value=JSON.stringify(Params,"",4);
    }

    function SmartSetInfo()
    {
        if(!idList2.value)
            return SetError("Need set params");
        var Params=JSON.parse(idList2.value);
        SendCall(0,"SetInfo",Params,[],SMART.Owner);
    }



    function SmartGetInfo()
    {
        idList2.value="";
        StaticCall(0,"GetInfo",{},[],function (Err,Value)
        {
            if(Err || !Value)
            {
                return;
            }
            idList2.value=JSON.stringify(Value,"",4);
        });

    }

    //--------------------------------------------------------------------------- Owner channel
    function GetEmpty()
    {
        var Params=
            {
                Name:"",
                Pause:0,
                SignPeriod:10,
                TransferPeriod:20,

                Rate:1,
                NotaryFee:0.001,
                MinNotaryFee:1,
                MinDeposit:10,
                MinSign:1,
                NotaryArr:[{Name:"",Addr:"0000000000000000000000000000000000000000",CanSign:1,AccDeposit:0,SumDeposit:0}],

                SlashRate:1,
                MinSlash:10,

                SignLib:144,
            };
        if(TESTMODE)
            Params.NotaryArr=[{Name:"=Test=",Addr:"5201A60DE4328750EC18C6BEA49B2DA10A82013F",CanSign:1,AccDeposit:SMART.Account,SumDeposit:10}];

        idList.value=JSON.stringify(Params,"",4);
    }

    function SetChannel()
    {
        if(idChannel.value)
        {
            var Params;
            if(idList.value)
            {
                Params=JSON.parse(idList.value);
                glInfo=Params;
            }
            else
            {
                return SetError("Need set params");
            }

            Params.AccountFrom=idChannel.value;

            MSendCall(0,"SetChannel",Params,[],SMART.Owner);
        }
    }



    function GetChannel()
    {
        idList.value="";
        MStaticCall(0,"GetChannel",{Channel:+idChannel.value},[],function (Err,Value)
        {
            if(Err)
                SetError(Value);

            if(Err || !Value)
                return;

            for(var i=0;i<Value.NotaryArr.length;i++)
            {
                var Item=Value.NotaryArr[i];
                Item.Addr=GetHexFromArr(Item.Addr);
            }

            delete Value.AccountFrom;
            idList.value=JSON.stringify(Value,"",4);
        });

    }




    //--------------------------------------------------------------------------- Notary mode


    function DoClearList()
    {
        SendClearOne(0);
        SendClearOne(1);
    }

    async function SendClearOne(bSlash)
    {
        var Arr=await GetOrderListTera(bSlash,1);
        Arr.sort(function(a,b){return b.ID-a.ID;});
        var Start=Arr.length-MAX_OLD_ORDER_LENGH;
        if(Start<0)
            Start=0;

        var bWasSend=0;
        for(var i=Start;i<Arr.length;i++)
        {
            var Order=Arr[i];
            SetOrderPeriod(Order);
            if(Order.PeriodNum>=4)
            {
                if(!bWasSend)
                {
                    //console.log(bSlash,Arr,Order);
                    console.log("Clear from: ",Order.ID);
                    MSendCall(SMART.Account,"ClearOrderList",{ID:Order.ID},[],+idCurAccount.value);
                    bWasSend=1;
                }


                delete OLib.MAP_TERA[Order.ID];
            }
        }
    }


    async function DoSignList()
    {
        if(!glPrivKey)
            return SetError("Not calc PrivKey");

        var Count=0;
        var Arr=await GetOrderListTera(0,0);
        for(var i=0;i<Arr.length;i++)
        {
            var Order=Arr[i];
            SetOrderPeriod(Order);
            if(Order.Period==="Signing")
            {
                DoSignOrder(Order);
                Count++;
                if(Count>=10)
                    break;
            }
        }

    }



    function DoSignOrder(Order)
    {
        if(HasSign(Order,glNotaryNum))
            return;


        var SignArr=GetSignOrder(Order,glPrivKey);
        MSendCall(SMART.Account,"NotarySign",{ID:Order.ID,Notary:glNotaryNum},SignArr,+idCurAccount.value);
    }


    function GetAddrFromPubKey(PubKeyArr)
    {
        return keccak256(PubKeyArr.slice(1)).slice(12);
    }


    function SetPubKey()
    {
        glPubKey=SignLib.publicKeyCreate(glPrivKey, 0);
        glAddr=GetHexFromArr(GetAddrFromPubKey(glPubKey));
        idPubKey.value=glAddr;
        SaveValues();
    }

    function CalcSecret()
    {
        idPrivKey.value=idPrivKey.value.trim();
        if(idPrivKey.value)
        {
            glPrivKey=GetArrFromHex(idPrivKey.value);
            SetPubKey();
        }
        else
        {
            var PubKey=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2];

            ComputeSecret(PubKey,function (ArrSecret)
            {
                glPrivKey=ArrSecret;
                SetPubKey();
            },+idCurAccount.value);
        }

    }
    function ShowPrivKey()
    {
        idPrivKey.value=GetHexFromArr(glPrivKey);
        SetPubKey();

        SetVisibleBlock("idPrivKey",1);
        setTimeout(function()
        {
            SetVisibleBlock("idPrivKey",0);
        },10*1000);

    }




    //--------------------------------------------------------------------------- Saving support
    function SaveValues()
    {
        SaveToStorageByArr(SaveIdArr);
    }
    function LoadValues()
    {
        LoadFromStorageByArr(SaveIdArr,function (Key)
        {
            CalcSecret();
        },1);
    }
    function PrepareSavingItems()
    {
        for(var n = 0; n < SaveIdArr.length; n++)
        {
            var Item = $(SaveIdArr[n]);
            Item.addEventListener("change",SaveValues);
        }
    }


    //--------------------------------------------------------------------------- common smart-contract lib
    function HasSign(Order,Notary)
    {
        var SignArr=Order.SignArr;
        for(var i=0;i<SignArr.length;i++)
        {
            if(SignArr[i].Notary===Notary)
                return 1;
        }
        return 0;
    }
    function GetOrderBlockNum(Order)
    {
        return Math.floor(Order.ID/1000);
    }




</script>




<style>
    body
    {
        background-color: #2E3857;
        color: white;
    }

    input
    {
        width: 70px;
    }

    button
    {
        height: 26px;
        width: 95px;
        margin: 5px;
        color:white;
        background-color: #2E3857;
        border: 1px solid #888;
    }

    button:hover
    {
        color: #cb763a;
        cursor: pointer;
    }
    .btlist
    {
        width: 150px;
        height:40px;
        margin:10px 2px 30px 2px;
    }


</style>

<div align="center" style="width:98%">
    <div align="left" style="max-width:400px">

        <div align='center' id="idMain" style="display:none">

            <menu>
                <item data-ref="mNotary" id="mNotary">
                    NOTARY
                </item>
                <item data-ref="mOwner" id="mOwner">
                    OWNER
                </item>
                <item data-ref="mTest" id="mTest">
                    TEST
                </item>
                <item data-ref="mlog">
                    Logs
                </item>

            </menu>



            <br><br>
            Channel: <input type="number" id="idChannel"  value="100" onchange="SaveValues()">
            <select size="1" id="idCurAccount" style="width: 180px" onchange="SaveValues()">
                <option value="0">Loading...</option>
            </select>
            <br>


            <content data-ref="mTest">
                <button onclick="AddNew()">Add order</button>
                <button onclick="SlashProof()">Slash Proof</button>
                <button onclick="DoOrderList()">List orders</button>
                <BR>
                Order: <input type="string" id="idOrder"  value="0">
                <button onclick="DoGetOrder(+idOrder.value)">Get</button>
                <button onclick="DoCancelOrder(+idOrder.value)">Order cancel</button>
                <BR>
                <button onclick="DoDeposit()">Deposit</button>
                <button onclick="DoWithdraw()">Withdraw</button>

            </content>


            <content data-ref="mNotary">
                <button onclick="DoSignList()" class="btlist">Orders SIGN</button>
                <button onclick="DoClearList()" class="btlist">List clear</button>
                <INPUT type="checkbox" id="idAutoRun" style="width:16px;vertical-align: middle" class="radius" value="0" ><span>Auto run</span>
                <br>

                Addr:
                <TEXTAREA id="idPubKey" rows="2" cols="40" style="width:99%"></TEXTAREA>
                Privat key:
                <TEXTAREA id="idPrivKey" rows="3" cols="40" style="display:none; width:99%" onchange="CalcSecret();"></TEXTAREA>
                <button onclick="CalcSecret()">Calc Secret</button>
                <button onclick="ShowPrivKey()">Show Secret</button>
                <button onclick="idPrivKey.value=null;CalcSecret()">Reset secret</button>
            </content>

            <content data-ref="mOwner">

                <menu>
                    <item data-ref="sChannel">
                        CHANNEL
                    </item>
                    <item data-ref="sSmart">
                        SMART
                    </item>
                </menu>

                <content data-ref="sChannel">
                    <button onclick="GetEmpty()">Empty</button>
                    <button onclick="GetChannel()">Get</button>
                    <button onclick="SetChannel()">Set bridge</button>
                    <br>
                    <TEXTAREA id="idList" rows="20" cols="40" style="width:99%"></TEXTAREA>
                </content>

                <content data-ref="sSmart">
                    <button onclick="SmartGetEmpty()">Empty</button>
                    <button onclick="SmartGetInfo()">Get</button>
                    <button onclick="SmartSetInfo()">Set smart</button>
                    <br>

                    <TEXTAREA id="idList2" rows="20" cols="40" style="width:99%"></TEXTAREA>
                </content>

            </content>

            <content data-ref="mlog">
                <button onclick="idLogs.value=null">Clear</button>
                <TEXTAREA id="idLogs" rows="22" cols="40" style="width:99%"></TEXTAREA>
            </content>

        </div>
    </div>
</div>









